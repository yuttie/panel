<!DOCTYPE html>

<html lang="en">
<head>
<!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta charset="utf-8"/>
<title>tornado.web — Panel 0.10.3 documentation</title>
<meta content="High-level dashboarding for python visualization libraries" name="description"/>
<meta content="Panel contributors" name="author"/>
<!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
    WebFont.load({
      google: {
        families: ['Source Sans Pro']
      }
    });
  </script>
<!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="../../_static/css/main.css" rel="stylesheet"/>
<link href="../../_static/nbsite.css" rel="stylesheet"/>
<link href="../../_static/site.css" rel="stylesheet"/>
<!-- Scripts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
</script>
<script src="../../_static/js/main.js"></script>
<!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="../../_static/favicon.ico" rel="icon" type="image/png"/>
<!-- Canonical
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="https://panel.holoviz.org/_modules/tornado/web.html" rel="canonical">
</link></head>
<body class="">
<header class="navigation">
<div class="wrapper">
<a class="logo" href="../../index.html">
<img alt="Logo" src="../../_static/logo_horizontal.png"/>
</a>
<a class="navigation-menu-button" href="javascript:void(0)" id="js-mobile-menu">Menu</a>
<nav>
<ul class="navigation-menu show" id="js-navigation-menu">
<li class="nav-link doc-head"><a href="//discourse.holoviz.org">Discourse</a></li>
<li class="nav-link doc-head"><a href="//twitter.com/Panel_org">Twitter</a></li>
<li class="nav-link doc-head"><a href="//github.com/pyviz/panel">Github</a></li>
<li class="nav-link">
<div style="display:inline-block;vertical-align: middle;">
<div class="search-bar">
<form action="../../search.html" method="get" role="search">
<input name="q" placeholder="Search" type="search"/>
<button type="submit">
<img alt="Search Icon" src="https://raw.githubusercontent.com/thoughtbot/refills/master/source/images/search-icon-black.png"/>
</button>
</form>
</div>
</div>
</li>
</ul>
</nav>
</div>
</header>
<div class="second-nav">
<nav>
<ul class="navigation-menu show">
<li class="nav-link doc-head"><a href="../../getting_started/index.html">Getting started</a></li>
<li class="nav-link doc-head"><a href="../../user_guide/index.html">User Guide</a></li>
<li class="nav-link doc-head"><a href="../../gallery/index.html">Gallery</a></li>
<li class="nav-link doc-head"><a href="../../reference/index.html">Reference Gallery</a></li>
<li class="nav-link doc-head"><a href="../../developer_guide/index.html">Developer Guide</a></li>
<li class="nav-link doc-head"><a href="../../releases.html">Releases</a></li>
<li class="nav-link doc-head"><a href="../../api/index.html">API</a></li>
<li class="nav-link doc-head"><a href="../../FAQ.html">FAQ</a></li>
<li class="nav-link doc-head"><a href="../../about.html">About</a></li>
</ul>
</nav>
</div>
<!-- MAIN BODY OF DOCS –––––––––––––––––– -->
<div class="docs section">
<div id="hacketyhackhack"> <!-- style="width:20%;margin-right: 100px;"> --> <!--style="display: none;"> style="display:none;"> -->
<div class="toc" style="width:15%; margin-right:20px;">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Comparisons.html">Comparisons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Roadmap.html">Road Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/pyviz/panel">Github source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>
</div>
</div>
<div class="content"> <!-- style="max-width:80%;margin-left:auto;margin-right: auto;">-->
<h1>Source code for tornado.web</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2009 Facebook</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the "License"); you may</span>
<span class="c1"># not use this file except in compliance with the License. You may obtain</span>
<span class="c1"># a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an "AS IS" BASIS, WITHOUT</span>
<span class="c1"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1"># License for the specific language governing permissions and limitations</span>
<span class="c1"># under the License.</span>

<span class="sd">"""``tornado.web`` provides a simple web framework with asynchronous</span>
<span class="sd">features that allow it to scale to large numbers of open connections,</span>
<span class="sd">making it ideal for `long polling</span>
<span class="sd">&lt;http://en.wikipedia.org/wiki/Push_technology#Long_polling&gt;`_.</span>

<span class="sd">Here is a simple "Hello, world" example app:</span>

<span class="sd">.. testcode::</span>

<span class="sd">    import tornado.ioloop</span>
<span class="sd">    import tornado.web</span>

<span class="sd">    class MainHandler(tornado.web.RequestHandler):</span>
<span class="sd">        def get(self):</span>
<span class="sd">            self.write("Hello, world")</span>

<span class="sd">    if __name__ == "__main__":</span>
<span class="sd">        application = tornado.web.Application([</span>
<span class="sd">            (r"/", MainHandler),</span>
<span class="sd">        ])</span>
<span class="sd">        application.listen(8888)</span>
<span class="sd">        tornado.ioloop.IOLoop.current().start()</span>

<span class="sd">.. testoutput::</span>
<span class="sd">   :hide:</span>


<span class="sd">See the :doc:`guide` for additional information.</span>

<span class="sd">Thread-safety notes</span>
<span class="sd">-------------------</span>

<span class="sd">In general, methods on `RequestHandler` and elsewhere in Tornado are</span>
<span class="sd">not thread-safe. In particular, methods such as</span>
<span class="sd">`~RequestHandler.write()`, `~RequestHandler.finish()`, and</span>
<span class="sd">`~RequestHandler.flush()` must only be called from the main thread. If</span>
<span class="sd">you use multiple threads it is important to use `.IOLoop.add_callback`</span>
<span class="sd">to transfer control back to the main thread before finishing the</span>
<span class="sd">request, or to limit your use of other threads to</span>
<span class="sd">`.IOLoop.run_in_executor` and ensure that your callbacks running in</span>
<span class="sd">the executor do not refer to Tornado objects.</span>

<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">email.utils</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">http.cookies</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tornado</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>

<span class="kn">from</span> <span class="nn">tornado.concurrent</span> <span class="kn">import</span> <span class="n">Future</span><span class="p">,</span> <span class="n">future_set_result_unless_cancelled</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">escape</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">gen</span>
<span class="kn">from</span> <span class="nn">tornado.httpserver</span> <span class="kn">import</span> <span class="n">HTTPServer</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">httputil</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">iostream</span>
<span class="kn">import</span> <span class="nn">tornado.locale</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">locale</span>
<span class="kn">from</span> <span class="nn">tornado.log</span> <span class="kn">import</span> <span class="n">access_log</span><span class="p">,</span> <span class="n">app_log</span><span class="p">,</span> <span class="n">gen_log</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">utf8</span><span class="p">,</span> <span class="n">_unicode</span>
<span class="kn">from</span> <span class="nn">tornado.routing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AnyMatches</span><span class="p">,</span>
    <span class="n">DefaultHostMatches</span><span class="p">,</span>
    <span class="n">HostMatches</span><span class="p">,</span>
    <span class="n">ReversibleRouter</span><span class="p">,</span>
    <span class="n">Rule</span><span class="p">,</span>
    <span class="n">ReversibleRuleRouter</span><span class="p">,</span>
    <span class="n">URLSpec</span><span class="p">,</span>
    <span class="n">_RuleList</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tornado.util</span> <span class="kn">import</span> <span class="n">ObjectDict</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">,</span> <span class="n">_websocket_mask</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">URLSpec</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">TracebackType</span>
<span class="kn">import</span> <span class="nn">typing</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>  <span class="c1"># noqa: F401</span>


<span class="c1"># The following types are accepted by RequestHandler.set_header</span>
<span class="c1"># and related methods.</span>
<span class="n">_HeaderTypes</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span>

<span class="n">_CookieSecretTypes</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span>


<span class="n">MIN_SUPPORTED_SIGNED_VALUE_VERSION</span> <span class="o">=</span> <span class="mi">1</span>
<span class="sd">"""The oldest signed value version supported by this version of Tornado.</span>

<span class="sd">Signed values older than this version cannot be decoded.</span>

<span class="sd">.. versionadded:: 3.2.1</span>
<span class="sd">"""</span>

<span class="n">MAX_SUPPORTED_SIGNED_VALUE_VERSION</span> <span class="o">=</span> <span class="mi">2</span>
<span class="sd">"""The newest signed value version supported by this version of Tornado.</span>

<span class="sd">Signed values newer than this version cannot be decoded.</span>

<span class="sd">.. versionadded:: 3.2.1</span>
<span class="sd">"""</span>

<span class="n">DEFAULT_SIGNED_VALUE_VERSION</span> <span class="o">=</span> <span class="mi">2</span>
<span class="sd">"""The signed value version produced by `.RequestHandler.create_signed_value`.</span>

<span class="sd">May be overridden by passing a ``version`` keyword argument.</span>

<span class="sd">.. versionadded:: 3.2.1</span>
<span class="sd">"""</span>

<span class="n">DEFAULT_SIGNED_VALUE_MIN_VERSION</span> <span class="o">=</span> <span class="mi">1</span>
<span class="sd">"""The oldest signed value accepted by `.RequestHandler.get_secure_cookie`.</span>

<span class="sd">May be overridden by passing a ``min_version`` keyword argument.</span>

<span class="sd">.. versionadded:: 3.2.1</span>
<span class="sd">"""</span>


<span class="k">class</span> <span class="nc">_ArgDefaultMarker</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">_ARG_DEFAULT</span> <span class="o">=</span> <span class="n">_ArgDefaultMarker</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""Base class for HTTP request handlers.</span>

<span class="sd">    Subclasses must define at least one of the methods defined in the</span>
<span class="sd">    "Entry points" section below.</span>

<span class="sd">    Applications should not construct `RequestHandler` objects</span>
<span class="sd">    directly and subclasses should not override ``__init__`` (override</span>
<span class="sd">    `~RequestHandler.initialize` instead).</span>

<span class="sd">    """</span>

    <span class="n">SUPPORTED_METHODS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"POST"</span><span class="p">,</span> <span class="s2">"DELETE"</span><span class="p">,</span> <span class="s2">"PATCH"</span><span class="p">,</span> <span class="s2">"PUT"</span><span class="p">,</span> <span class="s2">"OPTIONS"</span><span class="p">)</span>

    <span class="n">_template_loaders</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, template.BaseLoader]</span>
    <span class="n">_template_loader_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">_remove_control_chars_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[\x00-\x08\x0e-\x1f]"</span><span class="p">)</span>

    <span class="n">_stream_request_body</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Will be set in _execute.</span>
    <span class="n">_transforms</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: List[OutputTransform]</span>
    <span class="n">path_args</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: List[str]</span>
    <span class="n">path_kwargs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Dict[str, str]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">application</span><span class="p">:</span> <span class="s2">"Application"</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_finish</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_future</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">ObjectDict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ui_method</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">application</span><span class="o">.</span><span class="n">ui_methods</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># UIModules are available as both `modules` and `_tt_modules` in the</span>
        <span class="c1"># template namespace.  Historically only `modules` was available</span>
        <span class="c1"># but could be clobbered by user additions to the namespace.</span>
        <span class="c1"># The template {% module %} directive looks in `_tt_modules` to avoid</span>
        <span class="c1"># possible conflicts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">[</span><span class="s2">"_tt_modules"</span><span class="p">]</span> <span class="o">=</span> <span class="n">_UIModuleNamespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="o">.</span><span class="n">ui_modules</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">[</span><span class="s2">"modules"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">[</span><span class="s2">"_tt_modules"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># TODO: need to add set_close_callback to HTTPConnection interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">set_close_callback</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_connection_close</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">initialize</span> <span class="o">=</span> <span class="n">_initialize</span>  <span class="c1"># type: Callable[..., None]</span>
    <span class="sd">"""Hook for subclass initialization. Called for each request.</span>

<span class="sd">    A dictionary passed as the third argument of a ``URLSpec`` will be</span>
<span class="sd">    supplied as keyword arguments to ``initialize()``.</span>

<span class="sd">    Example::</span>

<span class="sd">        class ProfileHandler(RequestHandler):</span>
<span class="sd">            def initialize(self, database):</span>
<span class="sd">                self.database = database</span>

<span class="sd">            def get(self, username):</span>
<span class="sd">                ...</span>

<span class="sd">        app = Application([</span>
<span class="sd">            (r'/user/(.*)', ProfileHandler, dict(database=database)),</span>
<span class="sd">            ])</span>
<span class="sd">    """</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">"""An alias for `self.application.settings &lt;Application.settings&gt;`."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span>

    <span class="k">def</span> <span class="nf">_unimplemented_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">405</span><span class="p">)</span>

    <span class="n">head</span> <span class="o">=</span> <span class="n">_unimplemented_method</span>  <span class="c1"># type: Callable[..., Optional[Awaitable[None]]]</span>
    <span class="n">get</span> <span class="o">=</span> <span class="n">_unimplemented_method</span>  <span class="c1"># type: Callable[..., Optional[Awaitable[None]]]</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">_unimplemented_method</span>  <span class="c1"># type: Callable[..., Optional[Awaitable[None]]]</span>
    <span class="n">delete</span> <span class="o">=</span> <span class="n">_unimplemented_method</span>  <span class="c1"># type: Callable[..., Optional[Awaitable[None]]]</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">_unimplemented_method</span>  <span class="c1"># type: Callable[..., Optional[Awaitable[None]]]</span>
    <span class="n">put</span> <span class="o">=</span> <span class="n">_unimplemented_method</span>  <span class="c1"># type: Callable[..., Optional[Awaitable[None]]]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">_unimplemented_method</span>  <span class="c1"># type: Callable[..., Optional[Awaitable[None]]]</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="sd">"""Called at the beginning of a request before  `get`/`post`/etc.</span>

<span class="sd">        Override this method to perform common initialization regardless</span>
<span class="sd">        of the request method.</span>

<span class="sd">        Asynchronous support: Use ``async def`` or decorate this method with</span>
<span class="sd">        `.gen.coroutine` to make it asynchronous.</span>
<span class="sd">        If this method returns an  ``Awaitable`` execution will not proceed</span>
<span class="sd">        until the ``Awaitable`` is done.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">           Asynchronous support.</span>
<span class="sd">        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Called after the end of a request.</span>

<span class="sd">        Override this method to perform cleanup, logging, etc.</span>
<span class="sd">        This method is a counterpart to `prepare`.  ``on_finish`` may</span>
<span class="sd">        not produce any output, as it is called after the response</span>
<span class="sd">        has been sent to the client.</span>
<span class="sd">        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">on_connection_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Called in async handlers if the client closed the connection.</span>

<span class="sd">        Override this to clean up resources associated with</span>
<span class="sd">        long-lived connections.  Note that this method is called only if</span>
<span class="sd">        the connection was closed during asynchronous processing; if you</span>
<span class="sd">        need to do cleanup after every request override `on_finish`</span>
<span class="sd">        instead.</span>

<span class="sd">        Proxies may keep a connection open for a time (perhaps</span>
<span class="sd">        indefinitely) after the client has gone away, so this method</span>
<span class="sd">        may not be called promptly after the end user closes their</span>
<span class="sd">        connection.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">_has_stream_request_body</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_body_future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_body_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">iostream</span><span class="o">.</span><span class="n">StreamClosedError</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_body_future</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Resets all headers and content for this response."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"Server"</span><span class="p">:</span> <span class="s2">"TornadoServer/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">tornado</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"text/html; charset=UTF-8"</span><span class="p">,</span>
                <span class="s2">"Date"</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">format_timestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[bytes]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_default_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Override this to set HTTP headers at the beginning of the request.</span>

<span class="sd">        For example, this is the place to set a custom ``Server`` header.</span>
<span class="sd">        Note that setting such headers in the normal flow of request</span>
<span class="sd">        processing may not do what you want, since headers may be reset</span>
<span class="sd">        during error handling.</span>
<span class="sd">        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sets the status code for our response.</span>

<span class="sd">        :arg int status_code: Response status code.</span>
<span class="sd">        :arg str reason: Human-readable reason phrase describing the status</span>
<span class="sd">            code. If ``None``, it will be filled in from</span>
<span class="sd">            `http.client.responses` or "Unknown".</span>

<span class="sd">        .. versionchanged:: 5.0</span>

<span class="sd">           No longer validates that the response code is in</span>
<span class="sd">           `http.client.responses`.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">"Unknown"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">"""Returns the status code for our response."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>

    <span class="k">def</span> <span class="nf">set_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_HeaderTypes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sets the given response header name and value.</span>

<span class="sd">        All header values are converted to strings (`datetime` objects</span>
<span class="sd">        are formatted according to the HTTP specification for the</span>
<span class="sd">        ``Date`` header).</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_HeaderTypes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Adds the given response header and value.</span>

<span class="sd">        Unlike `set_header`, `add_header` may be called multiple times</span>
<span class="sd">        to return multiple values for the same header.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_header_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">clear_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Clears an outgoing header, undoing a previous `set_header` call.</span>

<span class="sd">        Note that this method does not apply to multi-valued headers</span>
<span class="sd">        set by `add_header`.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="n">_INVALID_HEADER_CHAR_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[\x00-\x1f]"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert_header_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_HeaderTypes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Convert the input value to a str. This type check is a bit</span>
        <span class="c1"># subtle: The bytes case only executes on python 3, and the</span>
        <span class="c1"># unicode case only executes on python 2, because the other</span>
        <span class="c1"># cases are covered by the first match for str.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>  <span class="c1"># py3</span>
            <span class="c1"># Non-ascii characters in headers are not well supported,</span>
            <span class="c1"># but if you pass bytes, use latin1 so they pass through as-is.</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"latin1"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>  <span class="c1"># py2</span>
            <span class="c1"># TODO: This is inconsistent with the use of latin1 above,</span>
            <span class="c1"># but it's been that way for a long time. Should it change?</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">utf8</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
            <span class="c1"># return immediately since we know the converted value will be safe</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">httputil</span><span class="o">.</span><span class="n">format_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Unsupported header value </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># If \n is allowed into the header, it is possible to inject</span>
        <span class="c1"># additional headers or split the request.</span>
        <span class="k">if</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_INVALID_HEADER_CHAR_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">retval</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unsafe header value </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get_argument</span><span class="p">(</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">_ArgDefaultMarker</span> <span class="o">=</span> <span class="n">_ARG_DEFAULT</span><span class="p">,</span> <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get_argument</span><span class="p">(</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_argument</span><span class="p">(</span>  <span class="c1"># noqa: F811</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_ArgDefaultMarker</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ARG_DEFAULT</span><span class="p">,</span>
        <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Returns the value of the argument with the given name.</span>

<span class="sd">        If default is not provided, the argument is considered to be</span>
<span class="sd">        required, and we raise a `MissingArgumentError` if it is missing.</span>

<span class="sd">        If the argument appears in the request more than once, we return the</span>
<span class="sd">        last value.</span>

<span class="sd">        This method searches both the query and body arguments.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_argument</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Returns a list of the arguments with the given name.</span>

<span class="sd">        If the argument is not present, returns an empty list.</span>

<span class="sd">        This method searches both the query and body arguments.</span>
<span class="sd">        """</span>

        <span class="c1"># Make sure `get_arguments` isn't accidentally being called with a</span>
        <span class="c1"># positional argument that's assumed to be a default (like in</span>
        <span class="c1"># `get_argument`.)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arguments</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_body_argument</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_ArgDefaultMarker</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ARG_DEFAULT</span><span class="p">,</span>
        <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Returns the value of the argument with the given name</span>
<span class="sd">        from the request body.</span>

<span class="sd">        If default is not provided, the argument is considered to be</span>
<span class="sd">        required, and we raise a `MissingArgumentError` if it is missing.</span>

<span class="sd">        If the argument appears in the url more than once, we return the</span>
<span class="sd">        last value.</span>

<span class="sd">        .. versionadded:: 3.2</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_argument</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body_arguments</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_body_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Returns a list of the body arguments with the given name.</span>

<span class="sd">        If the argument is not present, returns an empty list.</span>

<span class="sd">        .. versionadded:: 3.2</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arguments</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body_arguments</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_query_argument</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_ArgDefaultMarker</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ARG_DEFAULT</span><span class="p">,</span>
        <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Returns the value of the argument with the given name</span>
<span class="sd">        from the request query string.</span>

<span class="sd">        If default is not provided, the argument is considered to be</span>
<span class="sd">        required, and we raise a `MissingArgumentError` if it is missing.</span>

<span class="sd">        If the argument appears in the url more than once, we return the</span>
<span class="sd">        last value.</span>

<span class="sd">        .. versionadded:: 3.2</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_argument</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_arguments</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_query_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Returns a list of the query arguments with the given name.</span>

<span class="sd">        If the argument is not present, returns an empty list.</span>

<span class="sd">        .. versionadded:: 3.2</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arguments</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_arguments</span><span class="p">,</span> <span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_argument</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_ArgDefaultMarker</span><span class="p">],</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]],</span>
        <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arguments</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">_ArgDefaultMarker</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">MissingArgumentError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_arguments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]],</span> <span class="n">strip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">):</span>
                <span class="c1"># Get rid of any weird control chars (unless decoding gave</span>
                <span class="c1"># us bytes, in which case leave it alone)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_remove_control_chars_regex</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">decode_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Decodes an argument from the request.</span>

<span class="sd">        The argument has been percent-decoded and is now a byte string.</span>
<span class="sd">        By default, this method decodes the argument as utf-8 and returns</span>
<span class="sd">        a unicode string, but this may be overridden in subclasses.</span>

<span class="sd">        This method is used as a filter for both `get_argument()` and for</span>
<span class="sd">        values extracted from the url and passed to `get()`/`post()`/etc.</span>

<span class="sd">        The name of the argument is provided if known, but may be None</span>
<span class="sd">        (e.g. for unnamed groups in the url regex).</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span>
                <span class="mi">400</span><span class="p">,</span> <span class="s2">"Invalid unicode in </span><span class="si">%s</span><span class="s2">: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">"url"</span><span class="p">,</span> <span class="n">value</span><span class="p">[:</span><span class="mi">40</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">Morsel</span><span class="p">]:</span>
        <span class="sd">"""An alias for</span>
<span class="sd">        `self.request.cookies &lt;.httputil.HTTPServerRequest.cookies&gt;`."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span>

    <span class="k">def</span> <span class="nf">get_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Returns the value of the request cookie with the given name.</span>

<span class="sd">        If the named cookie is not present, returns ``default``.</span>

<span class="sd">        This method only returns cookies that were present in the request.</span>
<span class="sd">        It does not see the outgoing cookies set by `set_cookie` in this</span>
<span class="sd">        handler.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
        <span class="n">domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">expires</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"/"</span><span class="p">,</span>
        <span class="n">expires_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sets an outgoing cookie name/value with the given options.</span>

<span class="sd">        Newly-set cookies are not immediately visible via `get_cookie`;</span>
<span class="sd">        they are not present until the next request.</span>

<span class="sd">        expires may be a numeric timestamp as returned by `time.time`,</span>
<span class="sd">        a time tuple as returned by `time.gmtime`, or a</span>
<span class="sd">        `datetime.datetime` object.</span>

<span class="sd">        Additional keyword arguments are set on the cookies.Morsel</span>
<span class="sd">        directly.</span>
<span class="sd">        See https://docs.python.org/3/library/http.cookies.html#http.cookies.Morsel</span>
<span class="sd">        for available attributes.</span>
<span class="sd">        """</span>
        <span class="c1"># The cookie library only accepts type str, in both python 2 and 3</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">native_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[\x00-\x20]"</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="n">value</span><span class="p">):</span>
            <span class="c1"># Don't let us accidentally inject bad stuff</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid cookie </span><span class="si">%r</span><span class="s2">: </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_new_cookie"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">http</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">()</span>
            <span class="p">)</span>  <span class="c1"># type: http.cookies.SimpleCookie</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">morsel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">morsel</span><span class="p">[</span><span class="s2">"domain"</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="k">if</span> <span class="n">expires_days</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
            <span class="n">morsel</span><span class="p">[</span><span class="s2">"expires"</span><span class="p">]</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">format_timestamp</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">morsel</span><span class="p">[</span><span class="s2">"path"</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">"max_age"</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s2">"max-age"</span>

            <span class="c1"># skip falsy values for httponly and secure flags because</span>
            <span class="c1"># SimpleCookie sets them regardless</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"httponly"</span><span class="p">,</span> <span class="s2">"secure"</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">morsel</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">clear_cookie</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"/"</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Deletes the cookie with the given name.</span>

<span class="sd">        Due to limitations of the cookie protocol, you must pass the same</span>
<span class="sd">        path and domain to clear a cookie as were used when that cookie</span>
<span class="sd">        was set (but there is no way to find out on the server side</span>
<span class="sd">        which values were used for a given cookie).</span>

<span class="sd">        Similar to `set_cookie`, the effect of this method will not be</span>
<span class="sd">        seen until the following request.</span>
<span class="sd">        """</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_all_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"/"</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Deletes all the cookies the user sent with this request.</span>

<span class="sd">        See `clear_cookie` for more information on the path and domain</span>
<span class="sd">        parameters.</span>

<span class="sd">        Similar to `set_cookie`, the effect of this method will not be</span>
<span class="sd">        seen until the following request.</span>

<span class="sd">        .. versionchanged:: 3.2</span>

<span class="sd">           Added the ``path`` and ``domain`` parameters.</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_secure_cookie</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
        <span class="n">expires_days</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Signs and timestamps a cookie so it cannot be forged.</span>

<span class="sd">        You must specify the ``cookie_secret`` setting in your Application</span>
<span class="sd">        to use this method. It should be a long, random sequence of bytes</span>
<span class="sd">        to be used as the HMAC secret for the signature.</span>

<span class="sd">        To read a cookie set with this method, use `get_secure_cookie()`.</span>

<span class="sd">        Note that the ``expires_days`` parameter sets the lifetime of the</span>
<span class="sd">        cookie in the browser, but is independent of the ``max_age_days``</span>
<span class="sd">        parameter to `get_secure_cookie`.</span>
<span class="sd">        A value of None limits the lifetime to the current browser session.</span>

<span class="sd">        Secure cookies may contain arbitrary byte values, not just unicode</span>
<span class="sd">        strings (unlike regular cookies)</span>

<span class="sd">        Similar to `set_cookie`, the effect of this method will not be</span>
<span class="sd">        seen until the following request.</span>

<span class="sd">        .. versionchanged:: 3.2.1</span>

<span class="sd">           Added the ``version`` argument.  Introduced cookie version 2</span>
<span class="sd">           and made it the default.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_signed_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">),</span>
            <span class="n">expires_days</span><span class="o">=</span><span class="n">expires_days</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_signed_value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">"""Signs and timestamps a string so it cannot be forged.</span>

<span class="sd">        Normally used via set_secure_cookie, but provided as a separate</span>
<span class="sd">        method for non-cookie uses.  To decode a value not stored</span>
<span class="sd">        as a cookie use the optional value argument to get_secure_cookie.</span>

<span class="sd">        .. versionchanged:: 3.2.1</span>

<span class="sd">           Added the ``version`` argument.  Introduced cookie version 2</span>
<span class="sd">           and made it the default.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">"cookie_secret"</span><span class="p">,</span> <span class="s2">"secure cookies"</span><span class="p">)</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">"cookie_secret"</span><span class="p">]</span>
        <span class="n">key_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"key_version"</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"key_version setting must be used for secret_key dicts"</span><span class="p">)</span>
            <span class="n">key_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">"key_version"</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">create_signed_value</span><span class="p">(</span>
            <span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">key_version</span><span class="o">=</span><span class="n">key_version</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_secure_cookie</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_age_days</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
        <span class="n">min_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
        <span class="sd">"""Returns the given signed cookie if it validates, or None.</span>

<span class="sd">        The decoded cookie value is returned as a byte string (unlike</span>
<span class="sd">        `get_cookie`).</span>

<span class="sd">        Similar to `get_cookie`, this method only returns cookies that</span>
<span class="sd">        were present in the request. It does not see outgoing cookies set by</span>
<span class="sd">        `set_secure_cookie` in this handler.</span>

<span class="sd">        .. versionchanged:: 3.2.1</span>

<span class="sd">           Added the ``min_version`` argument.  Introduced cookie version 2;</span>
<span class="sd">           both versions 1 and 2 are accepted by default.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">"cookie_secret"</span><span class="p">,</span> <span class="s2">"secure cookies"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decode_signed_value</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">"cookie_secret"</span><span class="p">],</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">value</span><span class="p">,</span>
            <span class="n">max_age_days</span><span class="o">=</span><span class="n">max_age_days</span><span class="p">,</span>
            <span class="n">min_version</span><span class="o">=</span><span class="n">min_version</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_secure_cookie_key_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">"""Returns the signing key version of the secure cookie.</span>

<span class="sd">        The version is returned as int.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">"cookie_secret"</span><span class="p">,</span> <span class="s2">"secure cookies"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">get_signature_key_version</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permanent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sends a redirect to the given (optionally relative) URL.</span>

<span class="sd">        If the ``status`` argument is specified, that value is used as the</span>
<span class="sd">        HTTP status code; otherwise either 301 (permanent) or 302</span>
<span class="sd">        (temporary) is chosen based on the ``permanent`` argument.</span>
<span class="sd">        The default is 302 (temporary).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Cannot redirect after headers have been written"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">301</span> <span class="k">if</span> <span class="n">permanent</span> <span class="k">else</span> <span class="mi">302</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">300</span> <span class="o">&lt;=</span> <span class="n">status</span> <span class="o">&lt;=</span> <span class="mi">399</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Location"</span><span class="p">,</span> <span class="n">utf8</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Writes the given chunk to the output buffer.</span>

<span class="sd">        To write the output to the network, use the `flush()` method below.</span>

<span class="sd">        If the given chunk is a dictionary, we write it as JSON and set</span>
<span class="sd">        the Content-Type of the response to be ``application/json``.</span>
<span class="sd">        (if you want to send JSON as a different ``Content-Type``, call</span>
<span class="sd">        ``set_header`` *after* calling ``write()``).</span>

<span class="sd">        Note that lists are not converted to JSON because of a potential</span>
<span class="sd">        cross-site security vulnerability.  All JSON output should be</span>
<span class="sd">        wrapped in a dictionary.  More details at</span>
<span class="sd">        http://haacked.com/archive/2009/06/25/json-hijacking.aspx/ and</span>
<span class="sd">        https://github.com/facebook/tornado/issues/1009</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Cannot write() after finish()"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">unicode_type</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">"write() only accepts bytes, unicode, and dict objects"</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">". Lists not accepted for security reasons; see "</span>
                    <span class="o">+</span> <span class="s2">"http://www.tornadoweb.org/en/stable/web.html#tornado.web.RequestHandler.write"</span>  <span class="c1"># noqa: E501</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"application/json; charset=UTF-8"</span><span class="p">)</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Future[None]"</span><span class="p">:</span>
        <span class="sd">"""Renders the template with the given arguments as the response.</span>

<span class="sd">        ``render()`` calls ``finish()``, so no other output methods can be called</span>
<span class="sd">        after it.</span>

<span class="sd">        Returns a `.Future` with the same semantics as the one returned by `finish`.</span>
<span class="sd">        Awaiting this `.Future` is optional.</span>

<span class="sd">        .. versionchanged:: 5.1</span>

<span class="sd">           Now returns a `.Future` instead of ``None``.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Cannot render() after finish()"</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Insert the additional JS and CSS added by the modules on the page</span>
        <span class="n">js_embed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">js_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">css_embed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">css_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">html_heads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">html_bodies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_active_modules"</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">embed_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">embedded_javascript</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">embed_part</span><span class="p">:</span>
                <span class="n">js_embed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">embed_part</span><span class="p">))</span>
            <span class="n">file_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">javascript_files</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">file_part</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_part</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                    <span class="n">js_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_unicode</span><span class="p">(</span><span class="n">file_part</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">js_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">file_part</span><span class="p">)</span>
            <span class="n">embed_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">embedded_css</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">embed_part</span><span class="p">:</span>
                <span class="n">css_embed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">embed_part</span><span class="p">))</span>
            <span class="n">file_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">css_files</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">file_part</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_part</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                    <span class="n">css_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_unicode</span><span class="p">(</span><span class="n">file_part</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">css_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">file_part</span><span class="p">)</span>
            <span class="n">head_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">html_head</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">head_part</span><span class="p">:</span>
                <span class="n">html_heads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">head_part</span><span class="p">))</span>
            <span class="n">body_part</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">html_body</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">body_part</span><span class="p">:</span>
                <span class="n">html_bodies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">body_part</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">js_files</span><span class="p">:</span>
            <span class="c1"># Maintain order of JavaScript files given by modules</span>
            <span class="n">js</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_linked_js</span><span class="p">(</span><span class="n">js_files</span><span class="p">)</span>
            <span class="n">sloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="sa">b</span><span class="s2">"&lt;/body&gt;"</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">sloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">utf8</span><span class="p">(</span><span class="n">js</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">sloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">js_embed</span><span class="p">:</span>
            <span class="n">js_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_embed_js</span><span class="p">(</span><span class="n">js_embed</span><span class="p">)</span>
            <span class="n">sloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="sa">b</span><span class="s2">"&lt;/body&gt;"</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">sloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">js_bytes</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">sloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">css_files</span><span class="p">:</span>
            <span class="n">css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_linked_css</span><span class="p">(</span><span class="n">css_files</span><span class="p">)</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">b</span><span class="s2">"&lt;/head&gt;"</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">utf8</span><span class="p">(</span><span class="n">css</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">css_embed</span><span class="p">:</span>
            <span class="n">css_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_embed_css</span><span class="p">(</span><span class="n">css_embed</span><span class="p">)</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">b</span><span class="s2">"&lt;/head&gt;"</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="n">css_bytes</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">html_heads</span><span class="p">:</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">b</span><span class="s2">"&lt;/head&gt;"</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_heads</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">html_bodies</span><span class="p">:</span>
            <span class="n">hloc</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">b</span><span class="s2">"&lt;/body&gt;"</span><span class="p">)</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="p">[:</span><span class="n">hloc</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html_bodies</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">html</span><span class="p">[</span><span class="n">hloc</span><span class="p">:]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_linked_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">js_files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Default method used to render the final js links for the</span>
<span class="sd">        rendered webpage.</span>

<span class="sd">        Override this method in a sub-classed controller to change the output.</span>
<span class="sd">        """</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[str]</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">js_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_absolute</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_paths</span><span class="p">:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">unique_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s1">'&lt;script src="'</span>
            <span class="o">+</span> <span class="n">escape</span><span class="o">.</span><span class="n">xhtml_escape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">'" type="text/javascript"&gt;&lt;/script&gt;'</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_embed_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">js_embed</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">"""Default method used to render the final embedded js for the</span>
<span class="sd">        rendered webpage.</span>

<span class="sd">        Override this method in a sub-classed controller to change the output.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">b</span><span class="s1">'&lt;script type="text/javascript"&gt;</span><span class="se">\n</span><span class="s1">//&lt;![CDATA[</span><span class="se">\n</span><span class="s1">'</span>
            <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">js_embed</span><span class="p">)</span>
            <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">//]]&gt;</span><span class="se">\n</span><span class="s2">&lt;/script&gt;"</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_linked_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">css_files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Default method used to render the final css links for the</span>
<span class="sd">        rendered webpage.</span>

<span class="sd">        Override this method in a sub-classed controller to change the output.</span>
<span class="sd">        """</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_paths</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[str]</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">css_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_absolute</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_paths</span><span class="p">:</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">unique_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s1">'&lt;link href="'</span> <span class="o">+</span> <span class="n">escape</span><span class="o">.</span><span class="n">xhtml_escape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'" '</span>
            <span class="s1">'type="text/css" rel="stylesheet"/&gt;'</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_embed_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">css_embed</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">"""Default method used to render the final embedded css for the</span>
<span class="sd">        rendered webpage.</span>

<span class="sd">        Override this method in a sub-classed controller to change the output.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">'&lt;style type="text/css"&gt;</span><span class="se">\n</span><span class="s1">'</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">css_embed</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\n</span><span class="s2">&lt;/style&gt;"</span>

    <span class="k">def</span> <span class="nf">render_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">"""Generate the given template with the given arguments.</span>

<span class="sd">        We return the generated byte string (in utf8). To generate and</span>
<span class="sd">        write a template as a response, use render() above.</span>
<span class="sd">        """</span>
        <span class="c1"># If no template_path is specified, use the path of the calling file</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">template_path</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">web_file</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
            <span class="k">while</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span> <span class="o">==</span> <span class="n">web_file</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
            <span class="k">assert</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loader_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">template_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="p">:</span>
                <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_template_loader</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span>
                <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="p">[</span><span class="n">template_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">loader</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loader</span> <span class="o">=</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="p">[</span><span class="n">template_path</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template_namespace</span><span class="p">()</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">namespace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_template_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">"""Returns a dictionary to be used as the default template namespace.</span>

<span class="sd">        May be overridden by subclasses to add or modify values.</span>

<span class="sd">        The results of this method will be combined with additional</span>
<span class="sd">        defaults in the `tornado.template` module and keyword arguments</span>
<span class="sd">        to `render` or `render_string`.</span>
<span class="sd">        """</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="n">current_user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span>
            <span class="n">locale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">,</span>
            <span class="n">_</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span>
            <span class="n">pgettext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">pgettext</span><span class="p">,</span>
            <span class="n">static_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">static_url</span><span class="p">,</span>
            <span class="n">xsrf_form_html</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_form_html</span><span class="p">,</span>
            <span class="n">reverse_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namespace</span>

    <span class="k">def</span> <span class="nf">create_template_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">template</span><span class="o">.</span><span class="n">BaseLoader</span><span class="p">:</span>
        <span class="sd">"""Returns a new template loader for the given path.</span>

<span class="sd">        May be overridden by subclasses.  By default returns a</span>
<span class="sd">        directory-based loader on the given path, using the</span>
<span class="sd">        ``autoescape`` and ``template_whitespace`` application</span>
<span class="sd">        settings.  If a ``template_loader`` application setting is</span>
<span class="sd">        supplied, uses that instead.</span>
<span class="sd">        """</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span>
        <span class="k">if</span> <span class="s2">"template_loader"</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"template_loader"</span><span class="p">]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">"autoescape"</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="c1"># autoescape=None means "no escaping", so we have to be sure</span>
            <span class="c1"># to only pass this kwarg if the user asked for it.</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"autoescape"</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"autoescape"</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">"template_whitespace"</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"whitespace"</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">"template_whitespace"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">Loader</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_footers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Future[None]"</span><span class="p">:</span>
        <span class="sd">"""Flushes the current output buffer to the network.</span>

<span class="sd">        .. versionchanged:: 4.0</span>
<span class="sd">           Now returns a `.Future` if no callback is given.</span>

<span class="sd">        .. versionchanged:: 6.0</span>

<span class="sd">           The ``callback`` argument was removed.</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
                    <span class="n">chunk</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">transform_first_chunk</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">include_footers</span>
                <span class="p">)</span>
            <span class="c1"># Ignore the chunk and only write the headers for HEAD requests</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"HEAD"</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">""</span>

            <span class="c1"># Finalize the cookie headers (which have been stored in a side</span>
            <span class="c1"># object so an outgoing cookie could be overwritten before it</span>
            <span class="c1"># is sent).</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_new_cookie"</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_cookie</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s2">"Set-Cookie"</span><span class="p">,</span> <span class="n">cookie</span><span class="o">.</span><span class="n">OutputString</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>

            <span class="n">start_line</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">ResponseStartLine</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">write_headers</span><span class="p">(</span>
                <span class="n">start_line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">chunk</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">transform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">transform_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">include_footers</span><span class="p">)</span>
            <span class="c1"># Ignore the chunk and only write the headers for HEAD requests</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">"HEAD"</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>  <span class="c1"># type: Future[None]</span>
                <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">future</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"Future[None]"</span><span class="p">:</span>
        <span class="sd">"""Finishes this response, ending the HTTP request.</span>

<span class="sd">        Passing a ``chunk`` to ``finish()`` is equivalent to passing that</span>
<span class="sd">        chunk to ``write()`` and then calling ``finish()`` with no arguments.</span>

<span class="sd">        Returns a `.Future` which may optionally be awaited to track the sending</span>
<span class="sd">        of the response to the client. This `.Future` resolves when all the response</span>
<span class="sd">        data has been sent, and raises an error if the connection is closed before all</span>
<span class="sd">        data can be sent.</span>

<span class="sd">        .. versionchanged:: 5.1</span>

<span class="sd">           Now returns a `.Future` instead of ``None``.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"finish() called twice"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">chunk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="c1"># Automatically support ETags and add the Content-Length header if</span>
        <span class="c1"># we have not flushed any content yet.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">==</span> <span class="mi">200</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s2">"Etag"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_etag_header</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_etag_header</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">304</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">100</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">):</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">,</span> <span class="p">(</span>
                    <span class="s2">"Cannot send body with </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clear_representation_headers</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s2">"Content-Length"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="n">content_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Content-Length"</span><span class="p">,</span> <span class="n">content_length</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># Now that the request is finished, clear the callback we</span>
        <span class="c1"># set on the HTTPConnection (which would otherwise prevent the</span>
        <span class="c1"># garbage collection of the RequestHandler when there</span>
        <span class="c1"># are keepalive connections)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">set_close_callback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">include_footers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_break_cycles</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">future</span>

    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">iostream</span><span class="o">.</span><span class="n">IOStream</span><span class="p">:</span>
        <span class="sd">"""Take control of the underlying stream.</span>

<span class="sd">        Returns the underlying `.IOStream` object and stops all</span>
<span class="sd">        further HTTP processing. Intended for implementing protocols</span>
<span class="sd">        like websockets that tunnel over an HTTP handshake.</span>

<span class="sd">        This method is only supported when HTTP/1.1 is used.</span>

<span class="sd">        .. versionadded:: 5.1</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># TODO: add detach to HTTPConnection?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">_break_cycles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Break up a reference cycle between this handler and the</span>
        <span class="c1"># _ui_module closures to allow for faster GC on CPython.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sends the given HTTP error code to the browser.</span>

<span class="sd">        If `flush()` has already been called, it is not possible to send</span>
<span class="sd">        an error, so this method will simply terminate the response.</span>
<span class="sd">        If output has been written but not yet flushed, it will be discarded</span>
<span class="sd">        and replaced with the error page.</span>

<span class="sd">        Override `write_error()` to customize the error page that is returned.</span>
<span class="sd">        Additional keyword arguments are passed through to `write_error`.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_written</span><span class="p">:</span>
            <span class="n">gen_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Cannot send error response after headers written"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
                <span class="c1"># If we get an error between writing headers and finishing,</span>
                <span class="c1"># we are unlikely to be able to finish due to a</span>
                <span class="c1"># Content-Length mismatch. Try anyway to release the</span>
                <span class="c1"># socket.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">gen_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Failed to flush partial response"</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">reason</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"reason"</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"exc_info"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"exc_info"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exception</span><span class="o">.</span><span class="n">reason</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">app_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Uncaught exception in write_error"</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Override to implement custom error pages.</span>

<span class="sd">        ``write_error`` may call `write`, `render`, `set_header`, etc</span>
<span class="sd">        to produce output as usual.</span>

<span class="sd">        If this error was caused by an uncaught exception (including</span>
<span class="sd">        HTTPError), an ``exc_info`` triple will be available as</span>
<span class="sd">        ``kwargs["exc_info"]``.  Note that this exception may not be</span>
<span class="sd">        the "current" exception for purposes of methods like</span>
<span class="sd">        ``sys.exc_info()`` or ``traceback.format_exc``.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"serve_traceback"</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"exc_info"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># in debug mode, try to send a traceback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/plain"</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">"exc_info"</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span>
                <span class="s2">"&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&lt;/title&gt;"</span>
                <span class="s2">"&lt;body&gt;</span><span class="si">%(code)d</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&lt;/body&gt;&lt;/html&gt;"</span>
                <span class="o">%</span> <span class="p">{</span><span class="s2">"code"</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span><span class="p">}</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">locale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tornado</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">Locale</span><span class="p">:</span>
        <span class="sd">"""The locale for the current session.</span>

<span class="sd">        Determined by either `get_user_locale`, which you can override to</span>
<span class="sd">        set the locale based on, e.g., a user preference stored in a</span>
<span class="sd">        database, or `get_browser_locale`, which uses the ``Accept-Language``</span>
<span class="sd">        header.</span>

<span class="sd">        .. versionchanged: 4.1</span>
<span class="sd">           Added a property setter.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_locale"</span><span class="p">):</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_locale</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span> <span class="o">=</span> <span class="n">loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_browser_locale</span><span class="p">()</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span>

    <span class="nd">@locale</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">locale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">tornado</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">Locale</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_locale</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_user_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tornado</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">Locale</span><span class="p">]:</span>
        <span class="sd">"""Override to determine the locale from the authenticated user.</span>

<span class="sd">        If None is returned, we fall back to `get_browser_locale()`.</span>

<span class="sd">        This method should return a `tornado.locale.Locale` object,</span>
<span class="sd">        most likely obtained via a call like ``tornado.locale.get("en")``</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_browser_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"en_US"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tornado</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">Locale</span><span class="p">:</span>
        <span class="sd">"""Determines the user's locale from ``Accept-Language`` header.</span>

<span class="sd">        See http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.4</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="s2">"Accept-Language"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">languages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">"Accept-Language"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
            <span class="n">locales</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">languages</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"q="</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">locales</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">score</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">locales</span><span class="p">:</span>
                <span class="n">locales</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locales</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">codes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">"""The authenticated user for this request.</span>

<span class="sd">        This is set in one of two ways:</span>

<span class="sd">        * A subclass may override `get_current_user()`, which will be called</span>
<span class="sd">          automatically the first time ``self.current_user`` is accessed.</span>
<span class="sd">          `get_current_user()` will only be called once per request,</span>
<span class="sd">          and is cached for future access::</span>

<span class="sd">              def get_current_user(self):</span>
<span class="sd">                  user_cookie = self.get_secure_cookie("user")</span>
<span class="sd">                  if user_cookie:</span>
<span class="sd">                      return json.loads(user_cookie)</span>
<span class="sd">                  return None</span>

<span class="sd">        * It may be set as a normal variable, typically from an overridden</span>
<span class="sd">          `prepare()`::</span>

<span class="sd">              @gen.coroutine</span>
<span class="sd">              def prepare(self):</span>
<span class="sd">                  user_id_cookie = self.get_secure_cookie("user_id")</span>
<span class="sd">                  if user_id_cookie:</span>
<span class="sd">                      self.current_user = yield load_user(user_id_cookie)</span>

<span class="sd">        Note that `prepare()` may be a coroutine while `get_current_user()`</span>
<span class="sd">        may not, so the latter form is necessary if loading the user requires</span>
<span class="sd">        asynchronous operations.</span>

<span class="sd">        The user object may be any type of the application's choosing.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_current_user"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span>

    <span class="nd">@current_user</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">"""Override to determine the current user from, e.g., a cookie.</span>

<span class="sd">        This method may not be a coroutine.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_login_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Override to customize the login URL based on the request.</span>

<span class="sd">        By default, we use the ``login_url`` application setting.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">"login_url"</span><span class="p">,</span> <span class="s2">"@tornado.web.authenticated"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">"login_url"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_template_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Override to customize template path for each handler.</span>

<span class="sd">        By default, we use the ``template_path`` application setting.</span>
<span class="sd">        Return None to load templates relative to the calling file.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"template_path"</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xsrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">"""The XSRF-prevention token for the current user/session.</span>

<span class="sd">        To prevent cross-site request forgery, we set an '_xsrf' cookie</span>
<span class="sd">        and include the same '_xsrf' value as an argument with all POST</span>
<span class="sd">        requests. If the two do not match, we reject the form submission</span>
<span class="sd">        as a potential forgery.</span>

<span class="sd">        See http://en.wikipedia.org/wiki/Cross-site_request_forgery</span>

<span class="sd">        This property is of type `bytes`, but it contains only ASCII</span>
<span class="sd">        characters. If a character string is required, there is no</span>
<span class="sd">        need to base64-encode it; just decode the byte string as</span>
<span class="sd">        UTF-8.</span>

<span class="sd">        .. versionchanged:: 3.2.2</span>
<span class="sd">           The xsrf token will now be have a random mask applied in every</span>
<span class="sd">           request, which makes it safe to include the token in pages</span>
<span class="sd">           that are compressed.  See http://breachattack.com for more</span>
<span class="sd">           information on the issue fixed by this change.  Old (version 1)</span>
<span class="sd">           cookies will be converted to version 2 when this method is called</span>
<span class="sd">           unless the ``xsrf_cookie_version`` `Application` setting is</span>
<span class="sd">           set to 1.</span>

<span class="sd">        .. versionchanged:: 4.3</span>
<span class="sd">           The ``xsrf_cookie_kwargs`` `Application` setting may be</span>
<span class="sd">           used to supply additional cookie options (which will be</span>
<span class="sd">           passed directly to `set_cookie`). For example,</span>
<span class="sd">           ``xsrf_cookie_kwargs=dict(httponly=True, secure=True)``</span>
<span class="sd">           will set the ``secure`` and ``httponly`` flags on the</span>
<span class="sd">           ``_xsrf`` cookie.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_xsrf_token"</span><span class="p">):</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw_xsrf_token</span><span class="p">()</span>
            <span class="n">output_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"xsrf_cookie_version"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cookie_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"xsrf_cookie_kwargs"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">output_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">"|"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">b</span><span class="s2">"2"</span><span class="p">,</span>
                        <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span>
                        <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">_websocket_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">token</span><span class="p">)),</span>
                        <span class="n">utf8</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unknown xsrf cookie version </span><span class="si">%d</span><span class="s2">"</span><span class="p">,</span> <span class="n">output_version</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="ow">and</span> <span class="s2">"expires_days"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cookie_kwargs</span><span class="p">:</span>
                    <span class="n">cookie_kwargs</span><span class="p">[</span><span class="s2">"expires_days"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s2">"_xsrf"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span><span class="p">,</span> <span class="o">**</span><span class="n">cookie_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xsrf_token</span>

    <span class="k">def</span> <span class="nf">_get_raw_xsrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">"""Read or generate the xsrf token in its raw form.</span>

<span class="sd">        The raw_xsrf_token is a tuple containing:</span>

<span class="sd">        * version: the version of the cookie from which this token was read,</span>
<span class="sd">          or None if we generated a new token in this request.</span>
<span class="sd">        * token: the raw token data; random (non-ascii) bytes.</span>
<span class="sd">        * timestamp: the time this token was generated (will not be accurate</span>
<span class="sd">          for version 1 cookies)</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_raw_xsrf_token"</span><span class="p">):</span>
            <span class="n">cookie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie</span><span class="p">(</span><span class="s2">"_xsrf"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cookie</span><span class="p">:</span>
                <span class="n">version</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_xsrf_token</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_xsrf_token</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_xsrf_token</span>

    <span class="k">def</span> <span class="nf">_decode_xsrf_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cookie</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">"""Convert a cookie string into a the tuple form returned by</span>
<span class="sd">        _get_raw_xsrf_token.</span>
<span class="sd">        """</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_signed_value_version_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">cookie</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">mask_str</span><span class="p">,</span> <span class="n">masked_token</span><span class="p">,</span> <span class="n">timestamp_str</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

                    <span class="n">mask</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">mask_str</span><span class="p">))</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">_websocket_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">masked_token</span><span class="p">)))</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">version</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">timestamp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Treat unknown versions as not present instead of failing.</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Unknown xsrf cookie version"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">cookie</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
                <span class="c1"># We don't have a usable timestamp in older versions.</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Catch exceptions and return nothing instead of failing.</span>
            <span class="n">gen_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Uncaught exception in _decode_xsrf_token"</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">check_xsrf_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Verifies that the ``_xsrf`` cookie matches the ``_xsrf`` argument.</span>

<span class="sd">        To prevent cross-site request forgery, we set an ``_xsrf``</span>
<span class="sd">        cookie and include the same value as a non-cookie</span>
<span class="sd">        field with all ``POST`` requests. If the two do not match, we</span>
<span class="sd">        reject the form submission as a potential forgery.</span>

<span class="sd">        The ``_xsrf`` value may be set as either a form field named ``_xsrf``</span>
<span class="sd">        or in a custom HTTP header named ``X-XSRFToken`` or ``X-CSRFToken``</span>
<span class="sd">        (the latter is accepted for compatibility with Django).</span>

<span class="sd">        See http://en.wikipedia.org/wiki/Cross-site_request_forgery</span>

<span class="sd">        .. versionchanged:: 3.2.2</span>
<span class="sd">           Added support for cookie version 2.  Both versions 1 and 2 are</span>
<span class="sd">           supported.</span>
<span class="sd">        """</span>
        <span class="c1"># Prior to release 1.1.1, this check was ignored if the HTTP header</span>
        <span class="c1"># ``X-Requested-With: XMLHTTPRequest`` was present.  This exception</span>
        <span class="c1"># has been shown to be insecure and has been removed.  For more</span>
        <span class="c1"># information please see</span>
        <span class="c1"># http://www.djangoproject.com/weblog/2011/feb/08/security/</span>
        <span class="c1"># http://weblog.rubyonrails.org/2011/2/8/csrf-protection-bypass-in-ruby-on-rails</span>
        <span class="n">token</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">"_xsrf"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"X-Xsrftoken"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"X-Csrftoken"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">"'_xsrf' argument missing from POST"</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_xsrf_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">expected_token</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_raw_xsrf_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">"'_xsrf' argument has invalid format"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="n">utf8</span><span class="p">(</span><span class="n">expected_token</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">"XSRF cookie does not match POST argument"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xsrf_form_html</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""An HTML ``&lt;input/&gt;`` element to be included with all POST forms.</span>

<span class="sd">        It defines the ``_xsrf`` input value, which we check on all POST</span>
<span class="sd">        requests to prevent cross-site request forgery. If you have set</span>
<span class="sd">        the ``xsrf_cookies`` application setting, you must include this</span>
<span class="sd">        HTML within all of your HTML forms.</span>

<span class="sd">        In a template, this method should be called with ``{% module</span>
<span class="sd">        xsrf_form_html() %}``</span>

<span class="sd">        See `check_xsrf_cookie()` above for more information.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">'&lt;input type="hidden" name="_xsrf" value="'</span>
            <span class="o">+</span> <span class="n">escape</span><span class="o">.</span><span class="n">xhtml_escape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xsrf_token</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">'"/&gt;'</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">static_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Returns a static URL for the given relative static file path.</span>

<span class="sd">        This method requires you set the ``static_path`` setting in your</span>
<span class="sd">        application (which specifies the root directory of your static</span>
<span class="sd">        files).</span>

<span class="sd">        This method returns a versioned url (by default appending</span>
<span class="sd">        ``?v=&lt;signature&gt;``), which allows the static files to be</span>
<span class="sd">        cached indefinitely.  This can be disabled by passing</span>
<span class="sd">        ``include_version=False`` (in the default implementation;</span>
<span class="sd">        other static file implementations are not required to support</span>
<span class="sd">        this, but they may support other options).</span>

<span class="sd">        By default this method returns URLs relative to the current</span>
<span class="sd">        host, but if ``include_host`` is true the URL returned will be</span>
<span class="sd">        absolute.  If this handler has an ``include_host`` attribute,</span>
<span class="sd">        that value will be used as the default for all `static_url`</span>
<span class="sd">        calls that do not pass ``include_host`` as a keyword argument.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s2">"static_path"</span><span class="p">,</span> <span class="s2">"static_url"</span><span class="p">)</span>
        <span class="n">get_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">"static_handler_class"</span><span class="p">,</span> <span class="n">StaticFileHandler</span>
        <span class="p">)</span><span class="o">.</span><span class="n">make_static_url</span>

        <span class="k">if</span> <span class="n">include_host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include_host</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"include_host"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_host</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">protocol</span> <span class="o">+</span> <span class="s2">"://"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">host</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="s2">""</span>

        <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">get_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">require_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"this feature"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Raises an exception if the given app setting is not defined."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">"You must define the '</span><span class="si">%s</span><span class="s2">' setting in your "</span>
                <span class="s2">"application to use </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">reverse_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Alias for `Application.reverse_url`."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_etag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Computes the etag header to be used for this request.</span>

<span class="sd">        By default uses a hash of the content written so far.</span>

<span class="sd">        May be overridden to provide custom etag implementations,</span>
<span class="sd">        or may return None to disable tornado's default etag support.</span>
<span class="sd">        """</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer</span><span class="p">:</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">'"</span><span class="si">%s</span><span class="s1">"'</span> <span class="o">%</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_etag_header</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sets the response's Etag header using ``self.compute_etag()``.</span>

<span class="sd">        Note: no header will be set if ``compute_etag()`` returns ``None``.</span>

<span class="sd">        This method is called automatically when the request is finished.</span>
<span class="sd">        """</span>
        <span class="n">etag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_etag</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">etag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Etag"</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_etag_header</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""Checks the ``Etag`` header against requests's ``If-None-Match``.</span>

<span class="sd">        Returns ``True`` if the request's Etag matches and a 304 should be</span>
<span class="sd">        returned. For example::</span>

<span class="sd">            self.set_etag_header()</span>
<span class="sd">            if self.check_etag_header():</span>
<span class="sd">                self.set_status(304)</span>
<span class="sd">                return</span>

<span class="sd">        This method is called automatically when the request is finished,</span>
<span class="sd">        but may be called earlier for applications that override</span>
<span class="sd">        `compute_etag` and want to do an early check for ``If-None-Match``</span>
<span class="sd">        before completing the request.  The ``Etag`` header should be set</span>
<span class="sd">        (perhaps with `set_etag_header`) before calling this method.</span>
<span class="sd">        """</span>
        <span class="n">computed_etag</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Etag"</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
        <span class="c1"># Find all weak and strong etag values from If-None-Match header</span>
        <span class="c1"># because RFC 7232 allows multiple etag values in a single header.</span>
        <span class="n">etags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
            <span class="sa">br</span><span class="s1">'\*|(?:W/)?"[^"]*"'</span><span class="p">,</span> <span class="n">utf8</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"If-None-Match"</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">computed_etag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">etags</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">etags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">"*"</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use a weak comparison when comparing entity-tags.</span>
            <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">"W/"</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>

            <span class="k">for</span> <span class="n">etag</span> <span class="ow">in</span> <span class="n">etags</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">(</span><span class="n">etag</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">(</span><span class="n">computed_etag</span><span class="p">):</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">match</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">transforms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">"OutputTransform"</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Executes this request with the given output transforms."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPORTED_METHODS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">405</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="c1"># If XSRF cookies are turned on, reject form submissions without</span>
            <span class="c1"># the proper cookie</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">"GET"</span><span class="p">,</span>
                <span class="s2">"HEAD"</span><span class="p">,</span>
                <span class="s2">"OPTIONS"</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"xsrf_cookies"</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_xsrf_cookie</span><span class="p">()</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">result</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Tell the Application we've finished with prepare()</span>
                <span class="c1"># and are ready for the body to arrive.</span>
                <span class="n">future_set_result_unless_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepared_future</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">_has_stream_request_body</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
                <span class="c1"># In streaming mode request.body is a Future that signals</span>
                <span class="c1"># the body has been completely received.  The Future has no</span>
                <span class="c1"># result; the data has been passed to self.data_received</span>
                <span class="c1"># instead.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_body_future</span>
                <span class="k">except</span> <span class="n">iostream</span><span class="o">.</span><span class="n">StreamClosedError</span><span class="p">:</span>
                    <span class="k">return</span>

            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">path_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">path_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">result</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_finish</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">app_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Exception in exception handler"</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Unset result to avoid circular references</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="c1"># In case we failed before setting _prepared_future, do it</span>
                <span class="c1"># now (to unblock the HTTP server).  Note that this is not</span>
                <span class="c1"># in a finally block to avoid GC issues prior to Python 3.4.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="sd">"""Implement this method to handle streamed request data.</span>

<span class="sd">        Requires the `.stream_request_body` decorator.</span>

<span class="sd">        May be a coroutine for flow control.</span>
<span class="sd">        """</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Logs the current request.</span>

<span class="sd">        Sort of deprecated since this functionality was moved to the</span>
<span class="sd">        Application, but left in place for the benefit of existing apps</span>
<span class="sd">        that have overridden this method.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_request_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_request_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Finish</span><span class="p">):</span>
            <span class="c1"># Not an error; just finish the request without logging.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># An error here should still get a best-effort send_error()</span>
            <span class="c1"># to avoid leaking the connection.</span>
            <span class="n">app_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Error in exception logger"</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="c1"># Extra errors after the request has been finished should</span>
            <span class="c1"># be logged, but there is no reason to continue to try and</span>
            <span class="c1"># send a response.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">log_exception</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">typ</span><span class="p">:</span> <span class="s2">"Optional[Type[BaseException]]"</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">tb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TracebackType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Override to customize logging of uncaught exceptions.</span>

<span class="sd">        By default logs instances of `HTTPError` as warnings without</span>
<span class="sd">        stack traces (on the ``tornado.general`` logger), and all</span>
<span class="sd">        other exceptions as errors with stack traces (on the</span>
<span class="sd">        ``tornado.application`` logger).</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">HTTPError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">log_message</span><span class="p">:</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: "</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="n">log_message</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_summary</span><span class="p">()]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="n">gen_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">"Uncaught exception </span><span class="si">%s</span><span class="se">\n</span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request_summary</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ui_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">"UIModule"</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_active_modules"</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, UIModule]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">rendered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rendered</span>

        <span class="k">return</span> <span class="n">render</span>

    <span class="k">def</span> <span class="nf">_ui_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_representation_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 304 responses should not contain representation metadata</span>
        <span class="c1"># headers (defined in</span>
        <span class="c1"># https://tools.ietf.org/html/rfc7231#section-3.1)</span>
        <span class="c1"># not explicitly allowed by</span>
        <span class="c1"># https://tools.ietf.org/html/rfc7232#section-4.1</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Content-Encoding"</span><span class="p">,</span> <span class="s2">"Content-Language"</span><span class="p">,</span> <span class="s2">"Content-Type"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_header</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">stream_request_body</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">RequestHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">RequestHandler</span><span class="p">]:</span>
    <span class="sd">"""Apply to `RequestHandler` subclasses to enable streaming body support.</span>

<span class="sd">    This decorator implies the following changes:</span>

<span class="sd">    * `.HTTPServerRequest.body` is undefined, and body arguments will not</span>
<span class="sd">      be included in `RequestHandler.get_argument`.</span>
<span class="sd">    * `RequestHandler.prepare` is called when the request headers have been</span>
<span class="sd">      read instead of after the entire body has been read.</span>
<span class="sd">    * The subclass must define a method ``data_received(self, data):``, which</span>
<span class="sd">      will be called zero or more times as data is available.  Note that</span>
<span class="sd">      if the request has an empty body, ``data_received`` may not be called.</span>
<span class="sd">    * ``prepare`` and ``data_received`` may return Futures (such as via</span>
<span class="sd">      ``@gen.coroutine``, in which case the next method will not be called</span>
<span class="sd">      until those futures have completed.</span>
<span class="sd">    * The regular HTTP method (``post``, ``put``, etc) will be called after</span>
<span class="sd">      the entire body has been read.</span>

<span class="sd">    See the `file receiver demo &lt;https://github.com/tornadoweb/tornado/tree/master/demos/file_upload/&gt;`_</span>
<span class="sd">    for example usage.</span>
<span class="sd">    """</span>  <span class="c1"># noqa: E501</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"expected subclass of RequestHandler, got </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_stream_request_body</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="bp">cls</span>


<span class="k">def</span> <span class="nf">_has_stream_request_body</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">RequestHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"expected subclass of RequestHandler, got </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_stream_request_body</span>


<span class="k">def</span> <span class="nf">removeslash</span><span class="p">(</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]:</span>
    <span class="sd">"""Use this decorator to remove trailing slashes from the request path.</span>

<span class="sd">    For example, a request to ``/foo/`` would redirect to ``/foo`` with this</span>
<span class="sd">    decorator. Your request handler mapping should use a regular expression</span>
<span class="sd">    like ``r'/foo/*'`` in conjunction with using the decorator.</span>
<span class="sd">    """</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">RequestHandler</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"/"</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">):</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uri</span><span class="p">:</span>  <span class="c1"># don't try to redirect '/' to ''</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
                        <span class="n">uri</span> <span class="o">+=</span> <span class="s2">"?"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">addslash</span><span class="p">(</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]:</span>
    <span class="sd">"""Use this decorator to add a missing trailing slash to the request path.</span>

<span class="sd">    For example, a request to ``/foo`` would redirect to ``/foo/`` with this</span>
<span class="sd">    decorator. Your request handler mapping should use a regular expression</span>
<span class="sd">    like ``r'/foo/?'`` in conjunction with using the decorator.</span>
<span class="sd">    """</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">RequestHandler</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"/"</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">):</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">"/"</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">+=</span> <span class="s2">"?"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">_ApplicationRouter</span><span class="p">(</span><span class="n">ReversibleRuleRouter</span><span class="p">):</span>
    <span class="sd">"""Routing implementation used internally by `Application`.</span>

<span class="sd">    Provides a binding between `Application` and `RequestHandler`.</span>
<span class="sd">    This implementation extends `~.routing.ReversibleRuleRouter` in a couple of ways:</span>
<span class="sd">        * it allows to use `RequestHandler` subclasses as `~.routing.Rule` target and</span>
<span class="sd">        * it allows to use a list/tuple of rules as `~.routing.Rule` target.</span>
<span class="sd">        ``process_rule`` implementation will substitute this list with an appropriate</span>
<span class="sd">        `_ApplicationRouter` instance.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">:</span> <span class="s2">"Application"</span><span class="p">,</span> <span class="n">rules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_RuleList</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">Application</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="n">Rule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rule</span><span class="p">:</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">_ApplicationRouter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">target</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">rule</span>

    <span class="k">def</span> <span class="nf">get_target_delegate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">,</span> <span class="o">**</span><span class="n">target_params</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httputil</span><span class="o">.</span><span class="n">HTTPMessageDelegate</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">get_handler_delegate</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">**</span><span class="n">target_params</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_target_delegate</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">target_params</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Application</span><span class="p">(</span><span class="n">ReversibleRouter</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""A collection of request handlers that make up a web application.</span>

<span class="sd">    Instances of this class are callable and can be passed directly to</span>
<span class="sd">    HTTPServer to serve the application::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r"/", MainPageHandler),</span>
<span class="sd">        ])</span>
<span class="sd">        http_server = httpserver.HTTPServer(application)</span>
<span class="sd">        http_server.listen(8080)</span>
<span class="sd">        ioloop.IOLoop.current().start()</span>

<span class="sd">    The constructor for this class takes in a list of `~.routing.Rule`</span>
<span class="sd">    objects or tuples of values corresponding to the arguments of</span>
<span class="sd">    `~.routing.Rule` constructor: ``(matcher, target, [target_kwargs], [name])``,</span>
<span class="sd">    the values in square brackets being optional. The default matcher is</span>
<span class="sd">    `~.routing.PathMatches`, so ``(regexp, target)`` tuples can also be used</span>
<span class="sd">    instead of ``(PathMatches(regexp), target)``.</span>

<span class="sd">    A common routing target is a `RequestHandler` subclass, but you can also</span>
<span class="sd">    use lists of rules as a target, which create a nested routing configuration::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (HostMatches("example.com"), [</span>
<span class="sd">                (r"/", MainPageHandler),</span>
<span class="sd">                (r"/feed", FeedHandler),</span>
<span class="sd">            ]),</span>
<span class="sd">        ])</span>

<span class="sd">    In addition to this you can use nested `~.routing.Router` instances,</span>
<span class="sd">    `~.httputil.HTTPMessageDelegate` subclasses and callables as routing targets</span>
<span class="sd">    (see `~.routing` module docs for more information).</span>

<span class="sd">    When we receive requests, we iterate over the list in order and</span>
<span class="sd">    instantiate an instance of the first request class whose regexp</span>
<span class="sd">    matches the request path. The request class can be specified as</span>
<span class="sd">    either a class object or a (fully-qualified) name.</span>

<span class="sd">    A dictionary may be passed as the third element (``target_kwargs``)</span>
<span class="sd">    of the tuple, which will be used as keyword arguments to the handler's</span>
<span class="sd">    constructor and `~RequestHandler.initialize` method. This pattern</span>
<span class="sd">    is used for the `StaticFileHandler` in this example (note that a</span>
<span class="sd">    `StaticFileHandler` can be installed automatically with the</span>
<span class="sd">    static_path setting described below)::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r"/static/(.*)", web.StaticFileHandler, {"path": "/var/www"}),</span>
<span class="sd">        ])</span>

<span class="sd">    We support virtual hosts with the `add_handlers` method, which takes in</span>
<span class="sd">    a host regular expression as the first argument::</span>

<span class="sd">        application.add_handlers(r"www\.myhost\.com", [</span>
<span class="sd">            (r"/article/([0-9]+)", ArticleHandler),</span>
<span class="sd">        ])</span>

<span class="sd">    If there's no match for the current request's host, then ``default_host``</span>
<span class="sd">    parameter value is matched against host regular expressions.</span>


<span class="sd">    .. warning::</span>

<span class="sd">       Applications that do not use TLS may be vulnerable to :ref:`DNS</span>
<span class="sd">       rebinding &lt;dnsrebinding&gt;` attacks. This attack is especially</span>
<span class="sd">       relevant to applications that only listen on ``127.0.0.1`` or</span>
<span class="sd">       other private networks. Appropriate host patterns must be used</span>
<span class="sd">       (instead of the default of ``r'.*'``) to prevent this risk. The</span>
<span class="sd">       ``default_host`` argument must not be used in applications that</span>
<span class="sd">       may be vulnerable to DNS rebinding.</span>

<span class="sd">    You can serve static files by sending the ``static_path`` setting</span>
<span class="sd">    as a keyword argument. We will serve those files from the</span>
<span class="sd">    ``/static/`` URI (this is configurable with the</span>
<span class="sd">    ``static_url_prefix`` setting), and we will serve ``/favicon.ico``</span>
<span class="sd">    and ``/robots.txt`` from the same directory.  A custom subclass of</span>
<span class="sd">    `StaticFileHandler` can be specified with the</span>
<span class="sd">    ``static_handler_class`` setting.</span>

<span class="sd">    .. versionchanged:: 4.5</span>
<span class="sd">       Integration with the new `tornado.routing` module.</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handlers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_RuleList</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="s2">"OutputTransform"</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">settings</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">transforms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Type[OutputTransform]]</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"compress_response"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"gzip"</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GZipContentEncoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_host</span> <span class="o">=</span> <span class="n">default_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui_modules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"linkify"</span><span class="p">:</span> <span class="n">_linkify</span><span class="p">,</span>
            <span class="s2">"xsrf_form_html"</span><span class="p">:</span> <span class="n">_xsrf_form_html</span><span class="p">,</span>
            <span class="s2">"Template"</span><span class="p">:</span> <span class="n">TemplateModule</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui_methods</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Callable[..., str]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_modules</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ui_modules"</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_methods</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ui_methods"</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"static_path"</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">"static_path"</span><span class="p">]</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">handlers</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="n">static_url_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"static_url_prefix"</span><span class="p">,</span> <span class="s2">"/static/"</span><span class="p">)</span>
            <span class="n">static_handler_class</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">"static_handler_class"</span><span class="p">,</span> <span class="n">StaticFileHandler</span>
            <span class="p">)</span>
            <span class="n">static_handler_args</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"static_handler_args"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">static_handler_args</span><span class="p">[</span><span class="s2">"path"</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">static_url_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">"(.*)"</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">"/(favicon\.ico)"</span><span class="p">,</span>
                <span class="sa">r</span><span class="s2">"/(robots\.txt)"</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">static_handler_class</span><span class="p">,</span> <span class="n">static_handler_args</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"debug"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"autoreload"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"compiled_template_cache"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"static_hash_cache"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">"serve_traceback"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wildcard_router</span> <span class="o">=</span> <span class="n">_ApplicationRouter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_router</span> <span class="o">=</span> <span class="n">_ApplicationRouter</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="n">Rule</span><span class="p">(</span><span class="n">AnyMatches</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">wildcard_router</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="c1"># Automatically reload modified modules</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"autoreload"</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">autoreload</span>

            <span class="n">autoreload</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTTPServer</span><span class="p">:</span>
        <span class="sd">"""Starts an HTTP server for this application on the given port.</span>

<span class="sd">        This is a convenience alias for creating an `.HTTPServer`</span>
<span class="sd">        object and calling its listen method.  Keyword arguments not</span>
<span class="sd">        supported by `HTTPServer.listen &lt;.TCPServer.listen&gt;` are passed to the</span>
<span class="sd">        `.HTTPServer` constructor.  For advanced uses</span>
<span class="sd">        (e.g. multi-process mode), do not use this method; create an</span>
<span class="sd">        `.HTTPServer` and call its</span>
<span class="sd">        `.TCPServer.bind`/`.TCPServer.start` methods directly.</span>

<span class="sd">        Note that after calling this method you still need to call</span>
<span class="sd">        ``IOLoop.current().start()`` to start the server.</span>

<span class="sd">        Returns the `.HTTPServer` object.</span>

<span class="sd">        .. versionchanged:: 4.3</span>
<span class="sd">           Now returns the `.HTTPServer` object.</span>
<span class="sd">        """</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">server</span>

    <span class="k">def</span> <span class="nf">add_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host_handlers</span><span class="p">:</span> <span class="n">_RuleList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Appends the given handlers to our handler list.</span>

<span class="sd">        Host patterns are processed sequentially in the order they were</span>
<span class="sd">        added. All matching patterns will be considered.</span>
<span class="sd">        """</span>
        <span class="n">host_matcher</span> <span class="o">=</span> <span class="n">HostMatches</span><span class="p">(</span><span class="n">host_pattern</span><span class="p">)</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="n">host_matcher</span><span class="p">,</span> <span class="n">_ApplicationRouter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_handlers</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_router</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wildcard_router</span><span class="o">.</span><span class="n">add_rules</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">DefaultHostMatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host_matcher</span><span class="o">.</span><span class="n">host_pattern</span><span class="p">),</span> <span class="n">host_handlers</span><span class="p">)]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">"OutputTransform"</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transform_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_ui_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methods</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_methods</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">methods</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_methods</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">"__call__"</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ui_methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>

    <span class="k">def</span> <span class="nf">_load_ui_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_modules</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">modules</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_ui_modules</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">UIModule</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ui_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="c1"># Legacy HTTPServer interface</span>
        <span class="n">dispatcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">find_handler</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"_HandlerDelegate"</span><span class="p">:</span>
        <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_router</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">route</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="s2">"_HandlerDelegate"</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"default_handler_class"</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handler_delegate</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">"default_handler_class"</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"default_handler_args"</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_handler_delegate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ErrorHandler</span><span class="p">,</span> <span class="p">{</span><span class="s2">"status_code"</span><span class="p">:</span> <span class="mi">404</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">get_handler_delegate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">,</span>
        <span class="n">target_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">RequestHandler</span><span class="p">],</span>
        <span class="n">target_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">path_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">path_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"_HandlerDelegate"</span><span class="p">:</span>
        <span class="sd">"""Returns `~.httputil.HTTPMessageDelegate` that can serve a request</span>
<span class="sd">        for application and `RequestHandler` subclass.</span>

<span class="sd">        :arg httputil.HTTPServerRequest request: current HTTP request.</span>
<span class="sd">        :arg RequestHandler target_class: a `RequestHandler` class.</span>
<span class="sd">        :arg dict target_kwargs: keyword arguments for ``target_class`` constructor.</span>
<span class="sd">        :arg list path_args: positional arguments for ``target_class`` HTTP method that</span>
<span class="sd">            will be executed while handling a request (``get``, ``post`` or any other).</span>
<span class="sd">        :arg dict path_kwargs: keyword arguments for ``target_class`` HTTP method.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_HandlerDelegate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">target_class</span><span class="p">,</span> <span class="n">target_kwargs</span><span class="p">,</span> <span class="n">path_args</span><span class="p">,</span> <span class="n">path_kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">reverse_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Returns a URL path for handler named ``name``</span>

<span class="sd">        The handler must be added to the application as a named `URLSpec`.</span>

<span class="sd">        Args will be substituted for capturing groups in the `URLSpec` regex.</span>
<span class="sd">        They will be converted to strings if necessary, encoded as utf8,</span>
<span class="sd">        and url-escaped.</span>
<span class="sd">        """</span>
        <span class="n">reversed_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_router</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reversed_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reversed_url</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> not found in named urls"</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">RequestHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Writes a completed HTTP request to the logs.</span>

<span class="sd">        By default writes to the python root logger.  To change</span>
<span class="sd">        this behavior either subclass Application and override this method,</span>
<span class="sd">        or pass a function in the application settings dictionary as</span>
<span class="sd">        ``log_function``.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="s2">"log_function"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s2">"log_function"</span><span class="p">](</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">log_method</span> <span class="o">=</span> <span class="n">access_log</span><span class="o">.</span><span class="n">info</span>
        <span class="k">elif</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">log_method</span> <span class="o">=</span> <span class="n">access_log</span><span class="o">.</span><span class="n">warning</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_method</span> <span class="o">=</span> <span class="n">access_log</span><span class="o">.</span><span class="n">error</span>
        <span class="n">request_time</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">request_time</span><span class="p">()</span>
        <span class="n">log_method</span><span class="p">(</span>
            <span class="s2">"</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2">ms"</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">get_status</span><span class="p">(),</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">_request_summary</span><span class="p">(),</span>
            <span class="n">request_time</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">_HandlerDelegate</span><span class="p">(</span><span class="n">httputil</span><span class="o">.</span><span class="n">HTTPMessageDelegate</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">application</span><span class="p">:</span> <span class="n">Application</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">,</span>
        <span class="n">handler_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">RequestHandler</span><span class="p">],</span>
        <span class="n">handler_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">path_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]],</span>
        <span class="n">path_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler_class</span> <span class="o">=</span> <span class="n">handler_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler_kwargs</span> <span class="o">=</span> <span class="n">handler_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_args</span> <span class="o">=</span> <span class="n">path_args</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_kwargs</span> <span class="o">=</span> <span class="n">path_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[bytes]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_request_body</span> <span class="o">=</span> <span class="n">_has_stream_request_body</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler_class</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">headers_received</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_line</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">httputil</span><span class="o">.</span><span class="n">RequestStartLine</span><span class="p">,</span> <span class="n">httputil</span><span class="o">.</span><span class="n">ResponseStartLine</span><span class="p">],</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_request_body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_body_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_request_body</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">data_received</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_request_body</span><span class="p">:</span>
            <span class="n">future_set_result_unless_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_body_future</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_parse_body</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_connection_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_request_body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">on_connection_close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="c1"># If template cache is disabled (usually in the debug mode),</span>
        <span class="c1"># re-compile templates and reload static files on every</span>
        <span class="c1"># request so you don't need to restart to see changes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"compiled_template_cache"</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loader_lock</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">RequestHandler</span><span class="o">.</span><span class="n">_template_loaders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">loader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"static_hash_cache"</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">StaticFileHandler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler_class</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">handler_kwargs</span>
        <span class="p">)</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">transforms</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_request_body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">_prepared_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
        <span class="c1"># Note that if an exception escapes handler._execute it will be</span>
        <span class="c1"># trapped in the Future it returns (which we are ignoring here,</span>
        <span class="c1"># leaving it to be logged when the Future is GC'd).</span>
        <span class="c1"># However, that shouldn't happen because _execute has a blanket</span>
        <span class="c1"># except handler, and we cannot easily access the IOLoop here to</span>
        <span class="c1"># call add_future (because of the requirement to remain compatible</span>
        <span class="c1"># with WSGI)</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">convert_yielded</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">path_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">path_kwargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fut</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
        <span class="c1"># If we are streaming the request body, then execute() is finished</span>
        <span class="c1"># when the handler has prepared to receive the body.  If not,</span>
        <span class="c1"># it doesn't matter when execute() finishes (so we return None)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">_prepared_future</span>


<span class="k">class</span> <span class="nc">HTTPError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">"""An exception that will turn into an HTTP error response.</span>

<span class="sd">    Raising an `HTTPError` is a convenient alternative to calling</span>
<span class="sd">    `RequestHandler.send_error` since it automatically ends the</span>
<span class="sd">    current function.</span>

<span class="sd">    To customize the response sent with an `HTTPError`, override</span>
<span class="sd">    `RequestHandler.write_error`.</span>

<span class="sd">    :arg int status_code: HTTP status code.  Must be listed in</span>
<span class="sd">        `httplib.responses &lt;http.client.responses&gt;` unless the ``reason``</span>
<span class="sd">        keyword argument is given.</span>
<span class="sd">    :arg str log_message: Message to be written to the log for this error</span>
<span class="sd">        (will not be shown to the user unless the `Application` is in debug</span>
<span class="sd">        mode).  May contain ``%s``-style placeholders, which will be filled</span>
<span class="sd">        in with remaining positional parameters.</span>
<span class="sd">    :arg str reason: Keyword-only argument.  The HTTP "reason" phrase</span>
<span class="sd">        to pass in the status line along with ``status_code``.  Normally</span>
<span class="sd">        determined automatically from ``status_code``, but can be used</span>
<span class="sd">        to use a non-standard numeric code.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">log_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">=</span> <span class="n">log_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"reason"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_message</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">=</span> <span class="n">log_message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"%"</span><span class="p">,</span> <span class="s2">"</span><span class="si">%%</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">"HTTP </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="ow">or</span> <span class="n">httputil</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">"Unknown"</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">" ("</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_message</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="s2">")"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span>


<span class="k">class</span> <span class="nc">Finish</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">"""An exception that ends the request without producing an error response.</span>

<span class="sd">    When `Finish` is raised in a `RequestHandler`, the request will</span>
<span class="sd">    end (calling `RequestHandler.finish` if it hasn't already been</span>
<span class="sd">    called), but the error-handling methods (including</span>
<span class="sd">    `RequestHandler.write_error`) will not be called.</span>

<span class="sd">    If `Finish()` was created with no arguments, the pending response</span>
<span class="sd">    will be sent as-is. If `Finish()` was given an argument, that</span>
<span class="sd">    argument will be passed to `RequestHandler.finish()`.</span>

<span class="sd">    This can be a more convenient way to implement custom error pages</span>
<span class="sd">    than overriding ``write_error`` (especially in library code)::</span>

<span class="sd">        if self.current_user is None:</span>
<span class="sd">            self.set_status(401)</span>
<span class="sd">            self.set_header('WWW-Authenticate', 'Basic realm="something"')</span>
<span class="sd">            raise Finish()</span>

<span class="sd">    .. versionchanged:: 4.3</span>
<span class="sd">       Arguments passed to ``Finish()`` will be passed on to</span>
<span class="sd">       `RequestHandler.finish`.</span>
<span class="sd">    """</span>

    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MissingArgumentError</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
    <span class="sd">"""Exception raised by `RequestHandler.get_argument`.</span>

<span class="sd">    This is a subclass of `HTTPError`, so if it is uncaught a 400 response</span>
<span class="sd">    code will be used instead of 500 (and a stack trace will not be logged).</span>

<span class="sd">    .. versionadded:: 3.1</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">"Missing argument </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">arg_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_name</span> <span class="o">=</span> <span class="n">arg_name</span>


<span class="k">class</span> <span class="nc">ErrorHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">"""Generates an error response with ``status_code`` for all requests."""</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_xsrf_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># POSTs to an ErrorHandler don't actually have side effects,</span>
        <span class="c1"># so we don't need to check the xsrf token.  This allows POSTs</span>
        <span class="c1"># to the wrong url to return a 404 instead of 403.</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RedirectHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">"""Redirects the client to the given URL for all GET requests.</span>

<span class="sd">    You should provide the keyword argument ``url`` to the handler, e.g.::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r"/oldpath", web.RedirectHandler, {"url": "/newpath"}),</span>
<span class="sd">        ])</span>

<span class="sd">    `RedirectHandler` supports regular expression substitutions. E.g., to</span>
<span class="sd">    swap the first and second parts of a path while preserving the remainder::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r"/(.*?)/(.*?)/(.*)", web.RedirectHandler, {"url": "/{1}/{0}/{2}"}),</span>
<span class="sd">        ])</span>

<span class="sd">    The final URL is formatted with `str.format` and the substrings that match</span>
<span class="sd">    the capturing groups. In the above example, a request to "/a/b/c" would be</span>
<span class="sd">    formatted like::</span>

<span class="sd">        str.format("/{1}/{0}/{2}", "a", "b", "c")  # -&gt; "/b/a/c"</span>

<span class="sd">    Use Python's :ref:`format string syntax &lt;formatstrings&gt;` to customize how</span>
<span class="sd">    values are substituted.</span>

<span class="sd">    .. versionchanged:: 4.5</span>
<span class="sd">       Added support for substitutions into the destination URL.</span>

<span class="sd">    .. versionchanged:: 5.0</span>
<span class="sd">       If any query arguments are present, they will be copied to the</span>
<span class="sd">       destination URL.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">permanent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permanent</span> <span class="o">=</span> <span class="n">permanent</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">to_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_arguments</span><span class="p">:</span>
            <span class="c1"># TODO: figure out typing for the next line.</span>
            <span class="n">to_url</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">url_concat</span><span class="p">(</span>
                <span class="n">to_url</span><span class="p">,</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">httputil</span><span class="o">.</span><span class="n">qs_to_qsl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_arguments</span><span class="p">)),</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">to_url</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_permanent</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StaticFileHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">"""A simple handler that can serve static content from a directory.</span>

<span class="sd">    A `StaticFileHandler` is configured automatically if you pass the</span>
<span class="sd">    ``static_path`` keyword argument to `Application`.  This handler</span>
<span class="sd">    can be customized with the ``static_url_prefix``, ``static_handler_class``,</span>
<span class="sd">    and ``static_handler_args`` settings.</span>

<span class="sd">    To map an additional path to this handler for a static data directory</span>
<span class="sd">    you would add a line to your application like::</span>

<span class="sd">        application = web.Application([</span>
<span class="sd">            (r"/content/(.*)", web.StaticFileHandler, {"path": "/var/www"}),</span>
<span class="sd">        ])</span>

<span class="sd">    The handler constructor requires a ``path`` argument, which specifies the</span>
<span class="sd">    local root directory of the content to be served.</span>

<span class="sd">    Note that a capture group in the regex is required to parse the value for</span>
<span class="sd">    the ``path`` argument to the get() method (different than the constructor</span>
<span class="sd">    argument above); see `URLSpec` for details.</span>

<span class="sd">    To serve a file like ``index.html`` automatically when a directory is</span>
<span class="sd">    requested, set ``static_handler_args=dict(default_filename="index.html")``</span>
<span class="sd">    in your application settings, or add ``default_filename`` as an initializer</span>
<span class="sd">    argument for your ``StaticFileHandler``.</span>

<span class="sd">    To maximize the effectiveness of browser caching, this class supports</span>
<span class="sd">    versioned urls (by default using the argument ``?v=``).  If a version</span>
<span class="sd">    is given, we instruct the browser to cache this file indefinitely.</span>
<span class="sd">    `make_static_url` (also available as `RequestHandler.static_url`) can</span>
<span class="sd">    be used to construct a versioned url.</span>

<span class="sd">    This handler is intended primarily for use in development and light-duty</span>
<span class="sd">    file serving; for heavy traffic it will be more efficient to use</span>
<span class="sd">    a dedicated static file server (such as nginx or Apache).  We support</span>
<span class="sd">    the HTTP ``Accept-Ranges`` mechanism to return partial content (because</span>
<span class="sd">    some browsers require this functionality to be present to seek in</span>
<span class="sd">    HTML5 audio or video).</span>

<span class="sd">    **Subclassing notes**</span>

<span class="sd">    This class is designed to be extensible by subclassing, but because</span>
<span class="sd">    of the way static urls are generated with class methods rather than</span>
<span class="sd">    instance methods, the inheritance patterns are somewhat unusual.</span>
<span class="sd">    Be sure to use the ``@classmethod`` decorator when overriding a</span>
<span class="sd">    class method.  Instance methods may use the attributes ``self.path``</span>
<span class="sd">    ``self.absolute_path``, and ``self.modified``.</span>

<span class="sd">    Subclasses should only override methods discussed in this section;</span>
<span class="sd">    overriding other methods is error-prone.  Overriding</span>
<span class="sd">    ``StaticFileHandler.get`` is particularly problematic due to the</span>
<span class="sd">    tight coupling with ``compute_etag`` and other methods.</span>

<span class="sd">    To change the way static urls are generated (e.g. to match the behavior</span>
<span class="sd">    of another server or CDN), override `make_static_url`, `parse_url_path`,</span>
<span class="sd">    `get_cache_time`, and/or `get_version`.</span>

<span class="sd">    To replace all interaction with the filesystem (e.g. to serve</span>
<span class="sd">    static content from a database), override `get_content`,</span>
<span class="sd">    `get_content_size`, `get_modified_time`, `get_absolute_path`, and</span>
<span class="sd">    `validate_absolute_path`.</span>

<span class="sd">    .. versionchanged:: 3.1</span>
<span class="sd">       Many of the methods for subclasses were added in Tornado 3.1.</span>
<span class="sd">    """</span>

    <span class="n">CACHE_MAX_AGE</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># 10 years</span>

    <span class="n">_static_hashes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Optional[str]]</span>
    <span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>  <span class="c1"># protects _static_hashes</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default_filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_filename</span> <span class="o">=</span> <span class="n">default_filename</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_static_hashes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">include_body</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_body</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Set up our path instance variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_url_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">path</span>  <span class="c1"># make sure we don't refer to path instead of self.path again</span>
        <span class="n">absolute_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_absolute_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">absolute_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_modified_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_headers</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_return_304</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">request_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">range_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Range"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">range_header</span><span class="p">:</span>
            <span class="c1"># As per RFC 2616 14.16, if an invalid Range header is specified,</span>
            <span class="c1"># the request will be treated as if the header didn't exist.</span>
            <span class="n">request_range</span> <span class="o">=</span> <span class="n">httputil</span><span class="o">.</span><span class="n">_parse_request_range</span><span class="p">(</span><span class="n">range_header</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_size</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">request_range</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">request_range</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">size</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">))</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># As per RFC 2616 14.35.1, a range is not satisfiable only: if</span>
                <span class="c1"># the first requested byte is equal to or greater than the</span>
                <span class="c1"># content, or when a suffix with length 0 is specified.</span>
                <span class="c1"># https://tools.ietf.org/html/rfc7233#section-2.1</span>
                <span class="c1"># A byte-range-spec is invalid if the last-byte-pos value is present</span>
                <span class="c1"># and less than the first-byte-pos.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">416</span><span class="p">)</span>  <span class="c1"># Range Not Satisfiable</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/plain"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Content-Range"</span><span class="p">,</span> <span class="s2">"bytes */</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">size</span><span class="p">,))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="c1"># Clients sometimes blindly use a large range to limit their</span>
                <span class="c1"># download size; cap the endpoint at the actual file size.</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">size</span>
            <span class="c1"># Note: only return HTTP 206 if less than the entire range has been</span>
            <span class="c1"># requested. Not only is this semantically correct, but Chrome</span>
            <span class="c1"># refuses to play audio if it gets an HTTP 206 in response to</span>
            <span class="c1"># ``Range: bytes=0-``.</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="p">(</span><span class="n">end</span> <span class="ow">or</span> <span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">206</span><span class="p">)</span>  <span class="c1"># Partial Content</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span>
                    <span class="s2">"Content-Range"</span><span class="p">,</span> <span class="n">httputil</span><span class="o">.</span><span class="n">_get_content_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content_length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">elif</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content_length</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content_length</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content_length</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Content-Length"</span><span class="p">,</span> <span class="n">content_length</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_body</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">iostream</span><span class="o">.</span><span class="n">StreamClosedError</span><span class="p">:</span>
                    <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"HEAD"</span>

    <span class="k">def</span> <span class="nf">compute_etag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Sets the ``Etag`` header based on static url version.</span>

<span class="sd">        This allows efficient ``If-None-Match`` checks against cached</span>
<span class="sd">        versions, and sends the correct ``Etag`` for a partial response</span>
<span class="sd">        (i.e. the same ``Etag`` as the full file).</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">version_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="s1">'"</span><span class="si">%s</span><span class="s1">"'</span> <span class="o">%</span> <span class="p">(</span><span class="n">version_hash</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">set_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Sets the content and caching headers on the response.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Accept-Ranges"</span><span class="p">,</span> <span class="s2">"bytes"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etag_header</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Last-Modified"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">)</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>

        <span class="n">cache_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cache_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span>
                <span class="s2">"Expires"</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">cache_time</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">"Cache-Control"</span><span class="p">,</span> <span class="s2">"max-age="</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_time</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_extra_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">should_return_304</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""Returns True if the headers indicate that we should return 304.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="c1"># If client sent If-None-Match, use it, ignore If-Modified-Since</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"If-None-Match"</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_etag_header</span><span class="p">()</span>

        <span class="c1"># Check the If-Modified-Since, and don't send the result if the</span>
        <span class="c1"># content has not been modified</span>
        <span class="n">ims_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"If-Modified-Since"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ims_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date_tuple</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate</span><span class="p">(</span><span class="n">ims_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">date_tuple</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">if_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">date_tuple</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">if_since</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_absolute_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Returns the absolute location of ``path`` relative to ``root``.</span>

<span class="sd">        ``root`` is the path configured for this `StaticFileHandler`</span>
<span class="sd">        (in most cases the ``static_path`` `Application` setting).</span>

<span class="sd">        This class method may be overridden in subclasses.  By default</span>
<span class="sd">        it returns a filesystem path, but other strings may be used</span>
<span class="sd">        as long as they are unique and understood by the subclass's</span>
<span class="sd">        overridden `get_content`.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">abspath</span>

    <span class="k">def</span> <span class="nf">validate_absolute_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">absolute_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Validate and return the absolute path.</span>

<span class="sd">        ``root`` is the configured path for the `StaticFileHandler`,</span>
<span class="sd">        and ``path`` is the result of `get_absolute_path`</span>

<span class="sd">        This is an instance method called during request processing,</span>
<span class="sd">        so it may raise `HTTPError` or use methods like</span>
<span class="sd">        `RequestHandler.redirect` (return None after redirecting to</span>
<span class="sd">        halt further processing).  This is where 404 errors for missing files</span>
<span class="sd">        are generated.</span>

<span class="sd">        This method may modify the path before returning it, but note that</span>
<span class="sd">        any such modifications will not be understood by `make_static_url`.</span>

<span class="sd">        In instance methods, this method's result is available as</span>
<span class="sd">        ``self.absolute_path``.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="c1"># os.path.abspath strips a trailing /.</span>
        <span class="c1"># We must add it back to `root` so that we only match files</span>
        <span class="c1"># in a directory named `root` instead of files starting with</span>
        <span class="c1"># that prefix.</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="c1"># abspath always removes a trailing slash, except when</span>
            <span class="c1"># root is '/'. This is an unusual case, but several projects</span>
            <span class="c1"># have independently discovered this technique to disable</span>
            <span class="c1"># Tornado's path validation and (hopefully) do their own,</span>
            <span class="c1"># so we need to support it.</span>
            <span class="n">root</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>
        <span class="c1"># The trailing slash also needs to be temporarily added back</span>
        <span class="c1"># the requested path so a request to root/ will match.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">absolute_path</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> is not in root static directory"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># need to look at the request.path here for when path is empty</span>
            <span class="c1"># but there is some prefix to the path that was already</span>
            <span class="c1"># trimmed by the routing</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"/"</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">"/"</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">absolute_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> is not a file"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">absolute_path</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_content</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">abspath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">"""Retrieve the content of the requested resource which is located</span>
<span class="sd">        at the given absolute path.</span>

<span class="sd">        This class method may be overridden by subclasses.  Note that its</span>
<span class="sd">        signature is different from other overridable class methods</span>
<span class="sd">        (no ``settings`` argument); this is deliberate to ensure that</span>
<span class="sd">        ``abspath`` is able to stand on its own as a cache key.</span>

<span class="sd">        This method should either return a byte string or an iterator</span>
<span class="sd">        of byte strings.  The latter is preferred for large files</span>
<span class="sd">        as it helps reduce memory fragmentation.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># type: Optional[int]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span>
                <span class="k">if</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">remaining</span> <span class="o">&lt;</span> <span class="n">chunk_size</span><span class="p">:</span>
                    <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">remaining</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">chunk</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">return</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_content_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">abspath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Returns a version string for the resource at the given path.</span>

<span class="sd">        This class method may be overridden by subclasses.  The</span>
<span class="sd">        default implementation is a SHA-512 hash of the file's contents.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_content</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">stat_result</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_stat_result"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stat_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_result</span>

    <span class="k">def</span> <span class="nf">get_content_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">"""Retrieve the total size of the resource at the given path.</span>

<span class="sd">        This method may be overridden by subclasses.</span>

<span class="sd">        .. versionadded:: 3.1</span>

<span class="sd">        .. versionchanged:: 4.0</span>
<span class="sd">           This method is now always called, instead of only when</span>
<span class="sd">           partial results are requested.</span>
<span class="sd">        """</span>
        <span class="n">stat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stat_result</span><span class="o">.</span><span class="n">st_size</span>

    <span class="k">def</span> <span class="nf">get_modified_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]:</span>
        <span class="sd">"""Returns the time that ``self.absolute_path`` was last modified.</span>

<span class="sd">        May be overridden in subclasses.  Should return a `~datetime.datetime`</span>
<span class="sd">        object or None.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="n">stat_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat</span><span class="p">()</span>
        <span class="c1"># NOTE: Historically, this used stat_result[stat.ST_MTIME],</span>
        <span class="c1"># which truncates the fractional portion of the timestamp. It</span>
        <span class="c1"># was changed from that form to stat_result.st_mtime to</span>
        <span class="c1"># satisfy mypy (which disallows the bracket operator), but the</span>
        <span class="c1"># latter form returns a float instead of an int. For</span>
        <span class="c1"># consistency with the past (and because we have a unit test</span>
        <span class="c1"># that relies on this), we truncate the float here, although</span>
        <span class="c1"># I'm not sure that's the right thing to do.</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">stat_result</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">modified</span>

    <span class="k">def</span> <span class="nf">get_content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Returns the ``Content-Type`` header to be used for this request.</span>

<span class="sd">        .. versionadded:: 3.1</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">mime_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absolute_path</span><span class="p">)</span>
        <span class="c1"># per RFC 6713, use the appropriate type for a gzip compressed file</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s2">"gzip"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"application/gzip"</span>
        <span class="c1"># As of 2015-07-21 there is no bzip2 encoding defined at</span>
        <span class="c1"># http://www.iana.org/assignments/media-types/media-types.xhtml</span>
        <span class="c1"># So for that (and any other encoding), use octet-stream.</span>
        <span class="k">elif</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"application/octet-stream"</span>
        <span class="k">elif</span> <span class="n">mime_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mime_type</span>
        <span class="c1"># if mime_type not detected, use application/octet-stream</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"application/octet-stream"</span>

    <span class="k">def</span> <span class="nf">set_extra_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""For subclass to add extra headers to the response"""</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_cache_time</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modified</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">],</span> <span class="n">mime_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">"""Override to customize cache control behavior.</span>

<span class="sd">        Return a positive number of seconds to make the result</span>
<span class="sd">        cacheable for that amount of time or 0 to mark resource as</span>
<span class="sd">        cacheable for an unspecified amount of time (subject to</span>
<span class="sd">        browser heuristics).</span>

<span class="sd">        By default returns cache expiry of 10 years for resources requested</span>
<span class="sd">        with ``v`` argument.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CACHE_MAX_AGE</span> <span class="k">if</span> <span class="s2">"v"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_static_url</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_version</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Constructs a versioned url for the given path.</span>

<span class="sd">        This method may be overridden in subclasses (but note that it</span>
<span class="sd">        is a class method rather than an instance method).  Subclasses</span>
<span class="sd">        are only required to implement the signature</span>
<span class="sd">        ``make_static_url(cls, settings, path)``; other keyword</span>
<span class="sd">        arguments may be passed through `~RequestHandler.static_url`</span>
<span class="sd">        but are not standard.</span>

<span class="sd">        ``settings`` is the `Application.settings` dictionary.  ``path``</span>
<span class="sd">        is the static path being requested.  The url returned should be</span>
<span class="sd">        relative to the current host.</span>

<span class="sd">        ``include_version`` determines whether the generated URL should</span>
<span class="sd">        include the query string containing the version hash of the</span>
<span class="sd">        file corresponding to the given ``path``.</span>

<span class="sd">        """</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"static_url_prefix"</span><span class="p">,</span> <span class="s2">"/static/"</span><span class="p">)</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_version</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url</span>

        <span class="n">version_hash</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url</span>

        <span class="k">return</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">?v=</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">version_hash</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_url_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Converts a static URL path into a filesystem path.</span>

<span class="sd">        ``url_path`` is the path component of the URL with</span>
<span class="sd">        ``static_url_prefix`` removed.  The return value should be</span>
<span class="sd">        filesystem path relative to ``static_path``.</span>

<span class="sd">        This is the inverse of `make_static_url`.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">!=</span> <span class="s2">"/"</span><span class="p">:</span>
            <span class="n">url_path</span> <span class="o">=</span> <span class="n">url_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url_path</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Generate the version string to be used in static URLs.</span>

<span class="sd">        ``settings`` is the `Application.settings` dictionary and ``path``</span>
<span class="sd">        is the relative location of the requested asset on the filesystem.</span>
<span class="sd">        The returned value should be a string, or ``None`` if no version</span>
<span class="sd">        could be determined.</span>

<span class="sd">        .. versionchanged:: 3.1</span>
<span class="sd">           This method was previously recommended for subclasses to override;</span>
<span class="sd">           `get_content_version` is now preferred as it allows the base</span>
<span class="sd">           class to handle caching of the result.</span>
<span class="sd">        """</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_absolute_path</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">"static_path"</span><span class="p">],</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_cached_version</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_cached_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">hashes</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_static_hashes</span>
            <span class="k">if</span> <span class="n">abs_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hashes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hashes</span><span class="p">[</span><span class="n">abs_path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_content_version</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">gen_log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Could not open static file </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">)</span>
                    <span class="n">hashes</span><span class="p">[</span><span class="n">abs_path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">hsh</span> <span class="o">=</span> <span class="n">hashes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hsh</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hsh</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">FallbackHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">"""A `RequestHandler` that wraps another HTTP server callback.</span>

<span class="sd">    The fallback is a callable object that accepts an</span>
<span class="sd">    `~.httputil.HTTPServerRequest`, such as an `Application` or</span>
<span class="sd">    `tornado.wsgi.WSGIContainer`.  This is most useful to use both</span>
<span class="sd">    Tornado ``RequestHandlers`` and WSGI in the same server.  Typical</span>
<span class="sd">    usage::</span>

<span class="sd">        wsgi_app = tornado.wsgi.WSGIContainer(</span>
<span class="sd">            django.core.handlers.wsgi.WSGIHandler())</span>
<span class="sd">        application = tornado.web.Application([</span>
<span class="sd">            (r"/foo", FooHandler),</span>
<span class="sd">            (r".*", FallbackHandler, dict(fallback=wsgi_app),</span>
<span class="sd">        ])</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fallback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span> <span class="o">=</span> <span class="n">fallback</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_finish</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">OutputTransform</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""A transform modifies the result of an HTTP request (e.g., GZip encoding)</span>

<span class="sd">    Applications are not expected to create their own OutputTransforms</span>
<span class="sd">    or interact with them directly; the framework chooses which transforms</span>
<span class="sd">    (if any) to apply.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">transform_first_chunk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">,</span>
        <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">finishing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">transform_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">finishing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chunk</span>


<span class="k">class</span> <span class="nc">GZipContentEncoding</span><span class="p">(</span><span class="n">OutputTransform</span><span class="p">):</span>
    <span class="sd">"""Applies the gzip content encoding to the response.</span>

<span class="sd">    See http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.11</span>

<span class="sd">    .. versionchanged:: 4.0</span>
<span class="sd">        Now compresses all mime types beginning with ``text/``, instead</span>
<span class="sd">        of just a whitelist. (the whitelist is still used for certain</span>
<span class="sd">        non-text mime types).</span>
<span class="sd">    """</span>

    <span class="c1"># Whitelist of compressible mime types (in addition to any types</span>
    <span class="c1"># beginning with "text/").</span>
    <span class="n">CONTENT_TYPES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">"application/javascript"</span><span class="p">,</span>
            <span class="s2">"application/x-javascript"</span><span class="p">,</span>
            <span class="s2">"application/xml"</span><span class="p">,</span>
            <span class="s2">"application/atom+xml"</span><span class="p">,</span>
            <span class="s2">"application/json"</span><span class="p">,</span>
            <span class="s2">"application/xhtml+xml"</span><span class="p">,</span>
            <span class="s2">"image/svg+xml"</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># Python's GzipFile defaults to level 9, while most other gzip</span>
    <span class="c1"># tools (including gzip itself) default to 6, which is probably a</span>
    <span class="c1"># better CPU/size tradeoff.</span>
    <span class="n">GZIP_LEVEL</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="c1"># Responses that are too short are unlikely to benefit from gzipping</span>
    <span class="c1"># after considering the "Content-Encoding: gzip" header and the header</span>
    <span class="c1"># inside the gzip encoding.</span>
    <span class="c1"># Note that responses written in multiple chunks will be compressed</span>
    <span class="c1"># regardless of size.</span>
    <span class="n">MIN_LENGTH</span> <span class="o">=</span> <span class="mi">1024</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPServerRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span> <span class="o">=</span> <span class="s2">"gzip"</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Accept-Encoding"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compressible_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctype</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ctype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"text/"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTENT_TYPES</span>

    <span class="k">def</span> <span class="nf">transform_first_chunk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">,</span>
        <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">finishing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">httputil</span><span class="o">.</span><span class="n">HTTPHeaders</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="c1"># TODO: can/should this type be inherited from the superclass?</span>
        <span class="k">if</span> <span class="s2">"Vary"</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">"Vary"</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">", Accept-Encoding"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">"Vary"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Accept-Encoding"</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span><span class="p">:</span>
            <span class="n">ctype</span> <span class="o">=</span> <span class="n">_unicode</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">";"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compressible_type</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">finishing</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_LENGTH</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="s2">"Content-Encoding"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Encoding"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"gzip"</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">"w"</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">GZIP_LEVEL</span>
            <span class="p">)</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">finishing</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"Content-Length"</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="c1"># The original content length is no longer correct.</span>
                <span class="c1"># If this is the last (and only) chunk, we can set the new</span>
                <span class="c1"># content-length; otherwise we remove it and fall back to</span>
                <span class="c1"># chunked encoding.</span>
                <span class="k">if</span> <span class="n">finishing</span><span class="p">:</span>
                    <span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Length"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Length"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">transform_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">finishing</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzipping</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">finishing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gzip_value</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span>


<span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]:</span>
    <span class="sd">"""Decorate methods with this to require that the user be logged in.</span>

<span class="sd">    If the user is not logged in, they will be redirected to the configured</span>
<span class="sd">    `login url &lt;RequestHandler.get_login_url&gt;`.</span>

<span class="sd">    If you configure a login url with a query parameter, Tornado will</span>
<span class="sd">    assume you know what you're doing and use it as-is.  If not, it</span>
<span class="sd">    will add a `next` parameter so the login page knows where to send</span>
<span class="sd">    you once you're logged in.</span>
<span class="sd">    """</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">RequestHandler</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"HEAD"</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_login_url</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">"?"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
                        <span class="c1"># if login url is absolute, make next absolute too</span>
                        <span class="n">next_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">full_url</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="n">next_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span>
                    <span class="n">url</span> <span class="o">+=</span> <span class="s2">"?"</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">next</span><span class="o">=</span><span class="n">next_url</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">UIModule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""A re-usable, modular UI unit on a page.</span>

<span class="sd">    UI modules often execute additional queries, and they can include</span>
<span class="sd">    additional CSS and JavaScript that will be included in the output</span>
<span class="sd">    page, which is automatically inserted on page render.</span>

<span class="sd">    Subclasses of UIModule must override the `render` method.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">RequestHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">ui</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">locale</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">current_user</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Override in subclasses to return this module's output."""</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">embedded_javascript</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Override to return a JavaScript string</span>
<span class="sd">        to be embedded in the page."""</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">javascript_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">"""Override to return a list of JavaScript files needed by this module.</span>

<span class="sd">        If the return values are relative paths, they will be passed to</span>
<span class="sd">        `RequestHandler.static_url`; otherwise they will be used as-is.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">embedded_css</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Override to return a CSS string</span>
<span class="sd">        that will be embedded in the page."""</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">css_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="sd">"""Override to returns a list of CSS files required by this module.</span>

<span class="sd">        If the return values are relative paths, they will be passed to</span>
<span class="sd">        `RequestHandler.static_url`; otherwise they will be used as-is.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">html_head</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Override to return an HTML string that will be put in the &lt;head/&gt;</span>
<span class="sd">        element.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">html_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">"""Override to return an HTML string that will be put at the end of</span>
<span class="sd">        the &lt;body/&gt; element.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">render_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">"""Renders a template and returns it as a string."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_linkify</span><span class="p">(</span><span class="n">UIModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">escape</span><span class="o">.</span><span class="n">linkify</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_xsrf_form_html</span><span class="p">(</span><span class="n">UIModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">xsrf_form_html</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TemplateModule</span><span class="p">(</span><span class="n">UIModule</span><span class="p">):</span>
    <span class="sd">"""UIModule that simply renders the given template.</span>

<span class="sd">    {% module Template("foo.html") %} is similar to {% include "foo.html" %},</span>
<span class="sd">    but the module version gets its own namespace (with kwargs passed to</span>
<span class="sd">    Template()) instead of inheriting the outer template's namespace.</span>

<span class="sd">    Templates rendered through this module also get access to UIModule's</span>
<span class="sd">    automatic JavaScript/CSS features.  Simply call set_resources</span>
<span class="sd">    inside the template and give it keyword arguments corresponding to</span>
<span class="sd">    the methods on UIModule: {{ set_resources(js_files=static_url("my.js")) }}</span>
<span class="sd">    Note that these resources are output once per template file, not once</span>
<span class="sd">    per instantiation of the template, so they must not depend on</span>
<span class="sd">    any arguments to the template.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">RequestHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="c1"># keep resources in both a list and a dict to preserve order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str, Any]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, Dict[str, Any]]</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">def</span> <span class="nf">set_resources</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resource_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_dict</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">"set_resources called with different "</span>
                        <span class="s2">"resources for the same template"</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="s2">""</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">set_resources</span><span class="o">=</span><span class="n">set_resources</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_list</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">embedded_javascript</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s2">"embedded_javascript"</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">javascript_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s2">"javascript_files"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">embedded_css</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s2">"embedded_css"</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">css_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s2">"css_files"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">html_head</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s2">"html_head"</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">html_body</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_resources</span><span class="p">(</span><span class="s2">"html_body"</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_UIModuleNamespace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""Lazy namespace which creates UIModule proxies bound to a handler."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">RequestHandler</span><span class="p">,</span> <span class="n">ui_modules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">UIModule</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui_modules</span> <span class="o">=</span> <span class="n">ui_modules</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">_ui_module</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui_modules</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">create_signed_value</span><span class="p">(</span>
    <span class="n">secret</span><span class="p">:</span> <span class="n">_CookieSecretTypes</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">clock</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">key_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">DEFAULT_SIGNED_VALUE_VERSION</span>
    <span class="k">if</span> <span class="n">clock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clock</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">clock</span><span class="p">())))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">_create_signature_v1</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">"|"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">signature</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># The v2 format consists of a version number and a series of</span>
        <span class="c1"># length-prefixed fields "%d:%s", the last of which is a</span>
        <span class="c1"># signature, all separated by pipes.  All numbers are in</span>
        <span class="c1"># decimal format with no leading zeros.  The signature is an</span>
        <span class="c1"># HMAC-SHA256 of the whole string up to that point, including</span>
        <span class="c1"># the final pipe.</span>
        <span class="c1">#</span>
        <span class="c1"># The fields are:</span>
        <span class="c1"># - format version (i.e. 2; no length prefix)</span>
        <span class="c1"># - key version (integer, default is 0)</span>
        <span class="c1"># - timestamp (integer seconds since epoch)</span>
        <span class="c1"># - name (not encoded; assumed to be ~alphanumeric)</span>
        <span class="c1"># - value (base64-encoded)</span>
        <span class="c1"># - signature (hex-encoded; no length prefix)</span>
        <span class="k">def</span> <span class="nf">format_field</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">utf8</span><span class="p">(</span><span class="s2">"</span><span class="si">%d</span><span class="s2">:"</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">+</span> <span class="n">utf8</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">to_sign</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">"|"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">b</span><span class="s2">"2"</span><span class="p">,</span>
                <span class="n">format_field</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key_version</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="n">format_field</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
                <span class="n">format_field</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                <span class="n">format_field</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
                <span class="sa">b</span><span class="s2">""</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">key_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">),</span> <span class="s2">"Key version must be set when sign key dict is used"</span>
            <span class="k">assert</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"Version must be at least 2 for key version support"</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="p">[</span><span class="n">key_version</span><span class="p">]</span>

        <span class="n">signature</span> <span class="o">=</span> <span class="n">_create_signature_v2</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">to_sign</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_sign</span> <span class="o">+</span> <span class="n">signature</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unsupported version </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>


<span class="c1"># A leading version number in decimal</span>
<span class="c1"># with no leading zeros, followed by a pipe.</span>
<span class="n">_signed_value_version_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">br</span><span class="s2">"^([1-9][0-9]*)\|(.*)$"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_version</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># Figures out what version value is.  Version 1 did not include an</span>
    <span class="c1"># explicit version field and started with arbitrary base64 data,</span>
    <span class="c1"># which makes this tricky.</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_signed_value_version_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;</span> <span class="mi">999</span><span class="p">:</span>
                <span class="c1"># Certain payloads from the version-less v1 format may</span>
                <span class="c1"># be parsed as valid integers.  Due to base64 padding</span>
                <span class="c1"># restrictions, this can only happen for numbers whose</span>
                <span class="c1"># length is a multiple of 4, so we can treat all</span>
                <span class="c1"># numbers up to 999 as versions, and for the rest we</span>
                <span class="c1"># fall back to v1 format.</span>
                <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">version</span>


<span class="k">def</span> <span class="nf">decode_signed_value</span><span class="p">(</span>
    <span class="n">secret</span><span class="p">:</span> <span class="n">_CookieSecretTypes</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">max_age_days</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span>
    <span class="n">clock</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">clock</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clock</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span>
    <span class="k">if</span> <span class="n">min_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_version</span> <span class="o">=</span> <span class="n">DEFAULT_SIGNED_VALUE_MIN_VERSION</span>
    <span class="k">if</span> <span class="n">min_version</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unsupported min_version </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">min_version</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">_get_version</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">min_version</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_decode_signed_value_v1</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age_days</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_decode_signed_value_v2</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age_days</span><span class="p">,</span> <span class="n">clock</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_decode_signed_value_v1</span><span class="p">(</span>
    <span class="n">secret</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="n">max_age_days</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">clock</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">"|"</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">_create_signature_v1</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">signature</span><span class="p">):</span>
        <span class="n">gen_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Invalid cookie signature </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">max_age_days</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">:</span>
        <span class="n">gen_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Expired cookie </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">clock</span><span class="p">()</span> <span class="o">+</span> <span class="mi">31</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">:</span>
        <span class="c1"># _cookie_signature does not hash a delimiter between the</span>
        <span class="c1"># parts of the cookie, so an attacker could transfer trailing</span>
        <span class="c1"># digits from the payload to the timestamp without altering the</span>
        <span class="c1"># signature.  For backwards compatibility, sanity-check timestamp</span>
        <span class="c1"># here instead of modifying _cookie_signature.</span>
        <span class="n">gen_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Cookie timestamp in future; possible tampering </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">"0"</span><span class="p">):</span>
        <span class="n">gen_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Tampered cookie </span><span class="si">%r</span><span class="s2">"</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_decode_fields_v2</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">_consume_field</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="n">length</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="sa">b</span><span class="s2">":"</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="n">field_value</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="c1"># In python 3, indexing bytes returns small integers; we must</span>
        <span class="c1"># use a slice to get a byte string as in python 2.</span>
        <span class="k">if</span> <span class="n">rest</span><span class="p">[</span><span class="n">n</span> <span class="p">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">"|"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"malformed v2 signed value field"</span><span class="p">)</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">rest</span>

    <span class="n">rest</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># remove version number</span>
    <span class="n">key_version</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">_consume_field</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
    <span class="n">timestamp</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">_consume_field</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
    <span class="n">name_field</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">_consume_field</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
    <span class="n">value_field</span><span class="p">,</span> <span class="n">passed_sig</span> <span class="o">=</span> <span class="n">_consume_field</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">key_version</span><span class="p">),</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">name_field</span><span class="p">,</span> <span class="n">value_field</span><span class="p">,</span> <span class="n">passed_sig</span>


<span class="k">def</span> <span class="nf">_decode_signed_value_v2</span><span class="p">(</span>
    <span class="n">secret</span><span class="p">:</span> <span class="n">_CookieSecretTypes</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="n">max_age_days</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">clock</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">(</span>
            <span class="n">key_version</span><span class="p">,</span>
            <span class="n">timestamp_bytes</span><span class="p">,</span>
            <span class="n">name_field</span><span class="p">,</span>
            <span class="n">value_field</span><span class="p">,</span>
            <span class="n">passed_sig</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_decode_fields_v2</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">signed_string</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">passed_sig</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="p">[</span><span class="n">key_version</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">expected_sig</span> <span class="o">=</span> <span class="n">_create_signature_v2</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">signed_string</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">passed_sig</span><span class="p">,</span> <span class="n">expected_sig</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">name_field</span> <span class="o">!=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_bytes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">max_age_days</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">:</span>
        <span class="c1"># The signature has expired.</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">value_field</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_signature_key_version</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">utf8</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">_get_version</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">key_version</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_decode_fields_v2</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">key_version</span>


<span class="k">def</span> <span class="nf">_create_signature_v1</span><span class="p">(</span><span class="n">secret</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="o">*</span><span class="n">parts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">secret</span><span class="p">),</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">utf8</span><span class="p">(</span><span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_create_signature_v2</span><span class="p">(</span><span class="n">secret</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">s</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">secret</span><span class="p">),</span> <span class="n">digestmod</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span>
    <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">utf8</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">utf8</span><span class="p">(</span><span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">is_absolute</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"http:"</span><span class="p">,</span> <span class="s2">"https:"</span><span class="p">])</span>
</pre></div>
</div>
</div>
<!-- END MAIN BODY OF DOCS ––––––––––––– -->
<!-- Google Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-154795830-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154795830-2', { 'anonymize_ip': true });
</script>
<!-- MathJax Config -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>